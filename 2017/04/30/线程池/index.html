<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="多线程," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="这里首先介绍了java5中的并发的小工具包：java.util.concurrent.atomic，然后介绍了线程池的概念，对使用java5的方式创建不同形式的线程进行了演示，之后介绍了两个 对象：Callable和Future，用于获取线程执行后的结果，对于线程锁技术则在另外一篇文章中介绍。 Java5中的线程并发库都在java.util.concurrent包及子包中 1. Executor类">
<meta name="keywords" content="多线程">
<meta property="og:type" content="article">
<meta property="og:title" content="线程池">
<meta property="og:url" content="http://yoursite.com/2017/04/30/线程池/index.html">
<meta property="og:site_name" content="秋过冬漫长">
<meta property="og:description" content="这里首先介绍了java5中的并发的小工具包：java.util.concurrent.atomic，然后介绍了线程池的概念，对使用java5的方式创建不同形式的线程进行了演示，之后介绍了两个 对象：Callable和Future，用于获取线程执行后的结果，对于线程锁技术则在另外一篇文章中介绍。 Java5中的线程并发库都在java.util.concurrent包及子包中 1. Executor类">
<meta property="og:image" content="http://img.blog.csdn.net/20161024205013699">
<meta property="og:image" content="http://img.blog.csdn.net/20161025001312662">
<meta property="og:image" content="http://img.blog.csdn.net/20161025001328454">
<meta property="og:image" content="http://img.blog.csdn.net/20161025001336913">
<meta property="og:image" content="http://img.blog.csdn.net/20161025001349032">
<meta property="og:updated_time" content="2017-04-30T16:12:41.213Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="线程池">
<meta name="twitter:description" content="这里首先介绍了java5中的并发的小工具包：java.util.concurrent.atomic，然后介绍了线程池的概念，对使用java5的方式创建不同形式的线程进行了演示，之后介绍了两个 对象：Callable和Future，用于获取线程执行后的结果，对于线程锁技术则在另外一篇文章中介绍。 Java5中的线程并发库都在java.util.concurrent包及子包中 1. Executor类">
<meta name="twitter:image" content="http://img.blog.csdn.net/20161024205013699">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/04/30/线程池/"/>





  <title>线程池 | 秋过冬漫长</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">秋过冬漫长</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">没有比脚更长的路，走过去，前面是个天！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/30/线程池/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="JackChan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ai.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="秋过冬漫长">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                线程池
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-30T23:56:42+08:00">
                2017-04-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/30/线程池/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/04/30/线程池/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这里首先介绍了java5中的并发的小工具包：java.util.concurrent.atomic，然后介绍了线程池的概念，对使用java5的方式创建不同形式的线程进行了演示，之后介绍了两个 对象：Callable和Future，用于获取线程执行后的结果，对于<a href="线程锁技术.md">线程锁技术</a>则在另外一篇文章中介绍。</p>
<p>Java5中的线程并发库都在java.util.concurrent包及子包中</p>
<h1 id="1-Executor类的继承结构"><a href="#1-Executor类的继承结构" class="headerlink" title="1. Executor类的继承结构"></a><strong>1. Executor类的继承结构</strong></h1><p><img src="http://img.blog.csdn.net/20161024205013699" alt="ThreadPoolExecutor"></p>
<p>Executor是线程池的顶级接口，只有一个执行任务的方法execute()</p>
<p>ExecutorService是Executor的子接口，该接口中包含了线程池常用的一些方法</p>
<table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:left">功能描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">execute()</td>
<td style="text-align:left">执行任务</td>
</tr>
<tr>
<td style="text-align:left">shutdown()</td>
<td style="text-align:left">调用后不再接收新任务，如果里面有任务，就执行完</td>
</tr>
<tr>
<td style="text-align:left">shutdownNow()</td>
<td style="text-align:left">调用后不再接受新任务，如果有等待任务，移出队列；有正在执行的，尝试停止之</td>
</tr>
<tr>
<td style="text-align:left">isShutdown()</td>
<td style="text-align:left">判断线程池是否关闭</td>
</tr>
<tr>
<td style="text-align:left">isTerminated()</td>
<td style="text-align:left">判断线程池中任务是否执行完成</td>
</tr>
<tr>
<td style="text-align:left">submit()</td>
<td style="text-align:left">提交任务</td>
</tr>
<tr>
<td style="text-align:left">invokeAll()</td>
<td style="text-align:left">执行一组任务</td>
</tr>
</tbody>
</table>
<h1 id="2-ThreadPoolExecutor"><a href="#2-ThreadPoolExecutor" class="headerlink" title="2. ThreadPoolExecutor"></a><strong>2. ThreadPoolExecutor</strong></h1><p>ExecutorService的默认实现，同时也是Executors的底层实现</p>
<h2 id="2-1-构造方法"><a href="#2-1-构造方法" class="headerlink" title="2.1 构造方法"></a><strong>2.1 构造方法</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(</span></span></div><div class="line">    <span class="keyword">int</span> corePoolSize, //核心线程数</div><div class="line">    <span class="keyword">int</span> maximumPoolSize, //最大线程数</div><div class="line">    <span class="keyword">long</span> keepAliveTime, //保持时间</div><div class="line">    TimeUnit unit, //时间单位</div><div class="line">    BlockingQueue&lt;Runnable&gt; workQueue, //阻塞队列</div><div class="line">    ThreadFactory threadFactory, //线程工厂</div><div class="line">    RejectedExecutionHandler handler //异常捕获器</div><div class="line">)</div></pre></td></tr></table></figure>
<h3 id="2-1-1-int-corePoolSize"><a href="#2-1-1-int-corePoolSize" class="headerlink" title="2.1.1 int corePoolSize"></a><strong>2.1.1 int corePoolSize</strong></h3><p>核心池的大小，这个参数跟后面讲述的线程池的实现原理有非常大的关系。在创建了线程池后，默认情况下，线程池中并没有任何线程，而是等待有任务到来才创建线程去执行任务，除非调用了prestartAllCoreThreads()或者prestartCoreThread()方法，从这2个方法的名字就可以看出，是预创建线程的意思，即在没有任务到来之前就创建corePoolSize个线程或者一个线程。默认情况下，在创建了线程池后，线程池中的线程数为0，当有任务来之后，就会创建一个线程去执行任务，当线程池中的线程数目达到corePoolSize后，就会把到达的任务放到缓存队列当中</p>
<h3 id="2-1-2-int-maximumPoolSize"><a href="#2-1-2-int-maximumPoolSize" class="headerlink" title="2.1.2 int maximumPoolSize"></a><strong>2.1.2 int maximumPoolSize</strong></h3><p>线程池最大线程数，这个参数也是一个非常重要的参数，它表示在线程池中最多能创建多少个线程</p>
<h3 id="2-1-3-long-keepAliveTime"><a href="#2-1-3-long-keepAliveTime" class="headerlink" title="2.1.3 long keepAliveTime"></a><strong>2.1.3 long keepAliveTime</strong></h3><p>表示线程没有任务执行时最多保持多久时间会终止。默认情况下，只有当线程池中的线程数大于corePoolSize时，keepAliveTime才会起作用，直到线程池中的线程数不大于corePoolSize，即当线程池中的线程数大于corePoolSize时，如果一个线程空闲的时间达到keepAliveTime，则会终止，直到线程池中的线程数不超过corePoolSize。但是如果调用了allowCoreThreadTimeOut(boolean)方法，在线程池中的线程数不大于corePoolSize时，keepAliveTime参数也会起作用，直到线程池中的线程数为0</p>
<h3 id="2-1-4-TimeUnit-unit"><a href="#2-1-4-TimeUnit-unit" class="headerlink" title="2.1.4 TimeUnit unit"></a><strong>2.1.4 TimeUnit unit</strong></h3><p>参数keepAliveTime的时间单位，有7种取值</p>
<ul>
<li>TimeUnit.DAYS                        //天</li>
<li>TimeUnit.HOURS                    //小时</li>
<li>TimeUnit.MINUTES                 //分钟</li>
<li>TimeUnit.SECONDS               //秒</li>
<li>TimeUnit.MILLISECONDS      //毫秒</li>
<li>TimeUnit.MICROSECONDS      //微妙</li>
<li>TimeUnit.NANOSECONDS       //纳秒</li>
</ul>
<h3 id="2-1-5-RejectedExecutionHandler"><a href="#2-1-5-RejectedExecutionHandler" class="headerlink" title="2.1.5 RejectedExecutionHandler"></a><strong>2.1.5 RejectedExecutionHandler</strong></h3><ul>
<li><p>ThreadPoolExecutor.AbortPolicy<br>当添加任务出错时的策略捕获器，丢弃任务并抛出RejectedExecutionException异常</p>
</li>
<li><p>ThreadPoolExecutor.DiscardPolicy<br>也是丢弃任务，但是不抛出异常</p>
</li>
<li><p>ThreadPoolExecutor.DiscardOldestPolicy<br>丢弃队列最前面的任务，然后重新尝试执行任务（重复此过程）</p>
</li>
<li><p>ThreadPoolExecutor.CallerRunsPolicy<br>由调用线程处理该任务</p>
</li>
</ul>
<h1 id="3-任务提交给线程池之后的处理策略"><a href="#3-任务提交给线程池之后的处理策略" class="headerlink" title="3. 任务提交给线程池之后的处理策略"></a><strong>3. 任务提交给线程池之后的处理策略</strong></h1><p>3.1 如果当前线程池中的线程数目小于corePoolSize，则每来一个任务，就会创建执行这个任务</p>
<p><img src="http://img.blog.csdn.net/20161025001312662" alt="ThreadPoolExecutor"></p>
<p>3.2 如果当前线程池中的线程数目&gt;=corePoolSize，则每来一个任务，会尝试将其添加到任务缓存队列当中</p>
<p>3.2.1 若添加成功，则该任务会等待空闲线程将其取出去执行</p>
<p><img src="http://img.blog.csdn.net/20161025001328454" alt="ThreadPoolExecutor"></p>
<p>3.2.2 若添加失败（一般来说是任务缓存队列已满），则会尝试创建新的线程去执行这个任务</p>
<p><img src="http://img.blog.csdn.net/20161025001336913" alt="ThreadPoolExecutor"></p>
<p>3.3 如果当前线程池中的线程数目达到maximumPoolSize，则会采取任务拒绝策略进行处理</p>
<p><img src="http://img.blog.csdn.net/20161025001349032" alt="ThreadPoolExecutor"></p>
<p>如果线程池中的线程数量大于 corePoolSize时，如果某线程空闲时间超过keepAliveTime，线程将被终止，直至线程池中的线程数目不大于corePoolSize；如果允许为核心池中的线程设置存活时间，那么核心池中的线程空闲时间超过keepAliveTime，线程也会被终止</p>
<h1 id="4-阻塞队列的介绍"><a href="#4-阻塞队列的介绍" class="headerlink" title="4. 阻塞队列的介绍"></a><strong>4. 阻塞队列的介绍</strong></h1><h2 id="4-1-BlockingQueue"><a href="#4-1-BlockingQueue" class="headerlink" title="4.1 BlockingQueue"></a>4.1 BlockingQueue</h2><table>
<thead>
<tr>
<th style="text-align:left">阻塞队列</th>
<th style="text-align:left">功能描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">BlockingQueue</td>
<td style="text-align:left">阻塞队列的顶级接口，主要用于实现生产者消费者队列</td>
</tr>
<tr>
<td style="text-align:left">BlockingDeque</td>
<td style="text-align:left">双端队列</td>
</tr>
<tr>
<td style="text-align:left">SynchronousQueue</td>
<td style="text-align:left">同步队列，无界队列，直接提交策略，交替队列，在某次添加元素后必须等待其他线程取走后才能继续添加</td>
</tr>
<tr>
<td style="text-align:left">LinkedBlockingQueue</td>
<td style="text-align:left">无界队列，基于链表的阻塞队列，可以并发运行，FIFO</td>
</tr>
<tr>
<td style="text-align:left">ArrayBlockingQueue</td>
<td style="text-align:left">基于数组的有界(固定大小的数组)阻塞队列，只有put方法和take方法才具有阻塞功能，公平性  fairness</td>
</tr>
<tr>
<td style="text-align:left">PriorityBlockingQueue</td>
<td style="text-align:left">基于优先级的阻塞队列，依据对象的自然排序顺序或者是构造函数所带的Comparator决定的顺序</td>
</tr>
<tr>
<td style="text-align:left">DelayQueue</td>
<td style="text-align:left">延时队列</td>
</tr>
</tbody>
</table>
<h2 id="4-2-排队策略"><a href="#4-2-排队策略" class="headerlink" title="4.2 排队策略"></a>4.2 排队策略</h2><h3 id="直接提交"><a href="#直接提交" class="headerlink" title="直接提交"></a>直接提交</h3><p>工作队列的默认选项是 SynchronousQueue，它将任务直接提交给线程而不保持它们。在此，如果不存在可用于立即运行任务的线程，则试图把任务加入队列将失败，因此会构造一个新的线程。此策略可以避免在处理可能具有内部依赖性的请求集时出现锁。直接提交通常要求无界 maximumPoolSizes 以避免拒绝新提交的任务。当命令以超过队列所能处理的平均数连续到达时，此策略允许无界线程具有增长的可能性。</p>
<h3 id="无界队列"><a href="#无界队列" class="headerlink" title="无界队列"></a>无界队列</h3><p>使用无界队列（例如，不具有预定义容量的 LinkedBlockingQueue）使用无界队列将导致在所有 corePoolSize 线程都忙时新任务在队列中等待。这样，创建的线程就不会超过 corePoolSize。（因此，maximumPoolSize 的值也就无效了。）当每个任务完全独立于其他任务，即任务执行互不影响时，适合于使用无界队列。例如，在 Web 页服务器中。这种排队可用于处理瞬态突发请求，当命令以超过队列所能处理的平均数连续到达时，此策略允许无界线程具有增长的可能性</p>
<h3 id="有界队列"><a href="#有界队列" class="headerlink" title="有界队列"></a>有界队列</h3><p>当使用有限的 maximumPoolSizes 时，有界队列（如 ArrayBlockingQueue）有助于防止资源耗尽，但是可能较难调整和控制。队列大小和最大池大小可能需要相互折衷：使用大型队列和小型池可以最大限度地降低 CPU 使用率、操作系统资源和上下文切换开销，但是可能导致人工降低吞吐量。如果任务频繁阻塞（例如，如果它们是 I/O 边界），则系统可能为超过您许可的更多线程安排时间。使用小型队列通常要求较大的池大小，CPU 使用率较高，但是可能遇到不可接受的调度开销，这样也会降低吞吐量。</p>
<h2 id="4-3-BlockingQueue"><a href="#4-3-BlockingQueue" class="headerlink" title="4.3 BlockingQueue"></a>4.3 BlockingQueue</h2><table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:left">Throw exception  抛出异常</th>
<th style="text-align:left">Special value  特殊值</th>
<th style="text-align:left">Blocks   阻塞</th>
<th style="text-align:left">Time out  超时</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Insert</td>
<td style="text-align:left">add()</td>
<td style="text-align:left">offer()</td>
<td style="text-align:left">put()</td>
<td style="text-align:left">offer(e，time，unit)</td>
</tr>
<tr>
<td style="text-align:left">Remove</td>
<td style="text-align:left">remove()</td>
<td style="text-align:left">poll()</td>
<td style="text-align:left">take()</td>
<td style="text-align:left">poll(time，unit)</td>
</tr>
<tr>
<td style="text-align:left">Examine检查</td>
<td style="text-align:left">element()</td>
<td style="text-align:left">peek()</td>
<td style="text-align:left">不可用</td>
<td style="text-align:left">不可用</td>
</tr>
</tbody>
</table>
<p><code>BlockingQueue</code> 不接受 <code>null</code> 元素。试图 <code>add</code>、<code>put</code> 或 <code>offer</code> 一个 <code>null</code> 元素时，某些实现会抛出 <code>NullPointerException</code>。<code>null</code> 被用作指示 <code>poll</code> 操作失败的警戒值。 </p>
<p><code>BlockingQueue</code> 可以是限定容量的。它在任意给定时间都可以有一个 <code>remainingCapacity</code>，超出此容量，便无法无阻塞地 <code>put</code> 附加元素。没有任何内部容量约束的 <code>BlockingQueue</code> 总是报告 <code>Integer.MAX_VALUE</code> 的剩余容量。 </p>
<p><code>BlockingQueue</code> 实现主要用于生产者-使用者队列，但它另外还支持 <a href="../../../java/util/Collection.html"><code>Collection</code></a> 接口。因此，举例来说，使用 <code>remove(x)</code> 从队列中移除任意一个元素是有可能的。然而，这种操作通常<em>不</em> 会有效执行，只能有计划地偶尔使用，比如在取消排队信息时。 </p>
<p><code>BlockingQueue</code> 实现是线程安全的。所有排队方法都可以使用内部锁或其他形式的并发控制来自动达到它们的目的。然而，大量的 Collection 操作（<code>addAll</code>、<code>containsAll</code>、<code>retainAll</code> 和 <code>removeAll</code>）没有必要自动执行，除非在实现中特别说明。因此，举例来说，在只添加了 <code>c</code> 中的一些元素后，<code>addAll(c)</code> 有可能失败（抛出一个异常）。 </p>
<p><code>BlockingQueue</code> 实质上不支持使用任何一种“close”或“shutdown”操作来指示不再添加任何项。这种功能的需求和使用有依赖于实现的倾向。例如，一种常用的策略是：对于生产者，插入特殊的end-of-stream或poison对象，并根据使用者获取这些对象的时间来对它们进行解释。 </p>
<h2 id="4-4-BlockingDeque"><a href="#4-4-BlockingDeque" class="headerlink" title="4.4 BlockingDeque"></a>4.4 BlockingDeque</h2><p>双端队列</p>
<h2 id="4-5-ArrayBlockingQueue"><a href="#4-5-ArrayBlockingQueue" class="headerlink" title="4.5 ArrayBlockingQueue"></a>4.5 ArrayBlockingQueue</h2><p>一个由数组支持的有界<a href="../../../java/util/concurrent/BlockingQueue.html">阻塞队列</a>。此队列按 FIFO（先进先出）原则对元素进行排序。创建其对象必须明确大小，像数组一样。其内部实现是将对象放到一个数组里。有界也就意味着，它不能够存储无限多数量的元素。它有一个同一时间能够存储元素数量的上限。你可以在对其初始化的时候设定这个上限，但之后就无法对这个上限进行修改了(译者注：因为它是基于数组实现的，也就具有数组的特性：一旦初始化，大小就无法修改)。</p>
<p>实现互斥，你一下我一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockingQueueCondition</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        ExecutorService service = Executors.newSingleThreadExecutor();</div><div class="line">        <span class="keyword">final</span> Business3 business = <span class="keyword">new</span> Business3();</div><div class="line">        service.execute(<span class="keyword">new</span> Runnable()&#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">50</span>;i++)&#123;</div><div class="line">                    business.sub();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">50</span>;i++)&#123;</div><div class="line">            business.main();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Business3</span></span>&#123;</div><div class="line">    BlockingQueue subQueue  = <span class="keyword">new</span> ArrayBlockingQueue(<span class="number">1</span>);</div><div class="line">    BlockingQueue mainQueue = <span class="keyword">new</span> ArrayBlockingQueue(<span class="number">1</span>);</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            mainQueue.put(<span class="number">1</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sub</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">try</span></div><div class="line">        &#123;</div><div class="line">            mainQueue.take();</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</div><div class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" : "</span> + i);</div><div class="line">            &#125;</div><div class="line">            subQueue.put(<span class="number">1</span>);</div><div class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">try</span></div><div class="line">        &#123;</div><div class="line">            subQueue.take();</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</div><div class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" : "</span> + i);</div><div class="line">            &#125;</div><div class="line">            mainQueue.put(<span class="number">1</span>);</div><div class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">pool-1-thread-1 : 0</div><div class="line">pool-1-thread-1 : 1</div><div class="line">pool-1-thread-1 : 2</div><div class="line">pool-1-thread-1 : 3</div><div class="line">pool-1-thread-1 : 4</div><div class="line">pool-1-thread-1 : 5</div><div class="line">pool-1-thread-1 : 6</div><div class="line">pool-1-thread-1 : 7</div><div class="line">pool-1-thread-1 : 8</div><div class="line">pool-1-thread-1 : 9</div><div class="line">main : 0</div><div class="line">main : 1</div><div class="line">main : 2</div><div class="line">main : 3</div><div class="line">main : 4</div><div class="line">pool-1-thread-1 : 0</div><div class="line">pool-1-thread-1 : 1</div><div class="line">pool-1-thread-1 : 2</div><div class="line">pool-1-thread-1 : 3</div><div class="line">pool-1-thread-1 : 4</div><div class="line">pool-1-thread-1 : 5</div><div class="line">pool-1-thread-1 : 6</div><div class="line">pool-1-thread-1 : 7</div><div class="line">pool-1-thread-1 : 8</div><div class="line">pool-1-thread-1 : 9</div><div class="line">main : 0</div><div class="line">main : 1</div><div class="line">main : 2</div><div class="line">main : 3</div><div class="line">main : 4</div><div class="line">pool-1-thread-1 : 0</div><div class="line">pool-1-thread-1 : 1</div><div class="line">pool-1-thread-1 : 2</div><div class="line">pool-1-thread-1 : 3</div><div class="line">pool-1-thread-1 : 4</div><div class="line">pool-1-thread-1 : 5</div><div class="line">pool-1-thread-1 : 6</div><div class="line">pool-1-thread-1 : 7</div><div class="line">pool-1-thread-1 : 8</div><div class="line">pool-1-thread-1 : 9</div><div class="line">...</div></pre></td></tr></table></figure>
<h2 id="4-6-LinkedBlockingQueue"><a href="#4-6-LinkedBlockingQueue" class="headerlink" title="4.6 LinkedBlockingQueue"></a>4.6 LinkedBlockingQueue</h2><p>一个可改变大小的阻塞队列。此队列按 FIFO（先进先出）原则对元素进行排序。创建其对象如果没有明确大小，默认值是Integer.MAX_VALUE。链接队列的吞吐量通常要高于基于数组的队列，但是在大多数并发应用程序中，其可预知的性能要低。 </p>
<h2 id="4-7-SynchronousQueue"><a href="#4-7-SynchronousQueue" class="headerlink" title="4.7 SynchronousQueue"></a>4.7 SynchronousQueue</h2><p>同步队列。同步队列没有任何容量，每个插入必须等待另一个线程移除，反之亦然。是一个特殊的队列，它的内部同时只能够容纳单个元素。如果该队列已有一元素的话，试图向队列中插入一个新元素的线程将会阻塞，直到另一个线程将该元素从队列中抽走。同样，如果该队列为空，试图向队列中抽取一个元素的线程将会阻塞，直到另一个线程向队列中插入了一条新的元素。据此，把这个类称作一个队列显然是夸大其词了。它更多像是一个汇合点。</p>
<h2 id="4-8-DelayQueue"><a href="#4-8-DelayQueue" class="headerlink" title="4.8 DelayQueue"></a>4.8 DelayQueue</h2><p>延时队列，对元素进行持有直到一个特定的延迟到期，只有在延迟期满时才能从中提取元素。注入其中的元素必须实现 java.util.concurrent.Delayed 接口。</p>
<h2 id="4-9-PriorityBlockingQueue"><a href="#4-9-PriorityBlockingQueue" class="headerlink" title="4.9 PriorityBlockingQueue"></a>4.9 PriorityBlockingQueue</h2><p>基于优先级的阻塞队列，依据对象的自然排序顺序或者是构造函数所带的Comparator决定的顺序，应用：Volley</p>
<h2 id="4-10-生产者消费者"><a href="#4-10-生产者消费者" class="headerlink" title="4.10 生产者消费者"></a>4.10 生产者消费者</h2><p>生产者生产任务，消费者消费任务，那么这时就需要一个任务队列，生产者向队列里插入任务，消费者从队列里提取任务执行</p>
<h1 id="5-线程池工具类Executors"><a href="#5-线程池工具类Executors" class="headerlink" title="5. 线程池工具类Executors"></a><strong>5. 线程池工具类Executors</strong></h1><p>jdk1.5之后的一个新类，提供了一些静态工厂，生成一些常用的线程池，ThreadPoolExecutor是Executors类的底层实现</p>
<table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:left">功能描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">newCachedThreadPool()</td>
<td style="text-align:left">创建一个可缓存的线程池</td>
</tr>
<tr>
<td style="text-align:left">newFixedThreadPool()</td>
<td style="text-align:left">创建一个固定大小的线程池</td>
</tr>
<tr>
<td style="text-align:left">newScheduledThreadPool()</td>
<td style="text-align:left">创建一个大小无限的线程池。此线程池支持定时以及周期性执行任务的需求</td>
</tr>
<tr>
<td style="text-align:left">newSingleThreadExecutor()</td>
<td style="text-align:left">创建单个线程的线程池，始终保证线程池中会有一个线程在。当某线程死去，会找继任者</td>
</tr>
<tr>
<td style="text-align:left">defaultThreadFactory()</td>
<td style="text-align:left">创建一个默认线程池工厂</td>
</tr>
</tbody>
</table>
<h1 id="6-线程池"><a href="#6-线程池" class="headerlink" title="6. 线程池"></a><strong>6. 线程池</strong></h1><p>在线程池的编程模式下，任务是提交给整个线程池，而不是直接交给某个线程，线程池在拿到任务后，它就在内部找有无空闲的线程，再把任务交给内部某个空闲的线程，这就是封装</p>
<p>记住：任务是提交给整个线程池，一个线程同时只能执行一个任务，但可以同时向一个线程池提交多个任务。</p>
<p>示例：</p>
<ul>
<li>创建固定大小的线程池</li>
<li>创建缓存线程池  </li>
<li>用线程池创建定时器</li>
<li>创建单一线程池（始终保证线程池中会有一个线程在。当某线程死去，会找继任者）</li>
</ul>
<p>注意：</p>
<p>定时器中总是相对时间，我们要想指定具体时间的方法：比如明天早上10点钟执行，则可以使用明天早上10点的时间减去当前的时间，得到时间间隔</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;  </div><div class="line"><span class="keyword">import</span> java.util.concurrent.Executors;  </div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;  </div><div class="line">  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolTest</span> </span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;  </div><div class="line">          </div><div class="line">        <span class="comment">//创建固定大小的线程池，这里只能完成3个任务  </span></div><div class="line">        <span class="comment">//ExecutorService threadPool = Executors.newFixedThreadPool(3);  </span></div><div class="line">          </div><div class="line">        <span class="comment">//创建缓存线程池，根据任务来自动创建线程的数量，可以完成创建的所有任务  </span></div><div class="line">        <span class="comment">//ExecutorService threadPool = Executors.newCachedThreadPool();  </span></div><div class="line">          </div><div class="line">        <span class="comment">//创建单一线程池（始终保持线程池中有一个线程存活。当唯一线程死去，会创建新的继任者、  </span></div><div class="line">        ExecutorService threadPool = Executors.newSingleThreadExecutor();  </div><div class="line">          </div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">10</span>;i++)&#123;  </div><div class="line">　　<span class="comment">//内部类不能访问外部类的局部变量，所以i要定义为final，又由于i++.  </span></div><div class="line">　　<span class="comment">//所以在循环内部定义一个变量接收i  </span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> task = i;  </div><div class="line">        threadPool.execute(<span class="keyword">new</span> Runnable() &#123;  </div><div class="line">              </div><div class="line">            <span class="meta">@Override</span>  </div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </div><div class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=<span class="number">10</span>;j++)&#123;  </div><div class="line">                    System.out.println(Thread.currentThread().getName()  </div><div class="line">                            +<span class="string">" is looping of "</span>+ j+<span class="string">"  for task of "</span> +task);  </div><div class="line">                &#125;  </div><div class="line">                  </div><div class="line">            &#125;  </div><div class="line">        &#125;);  </div><div class="line">        &#125;  </div><div class="line">        <span class="comment">//验证10个任务都提交给了线程池  </span></div><div class="line">        System.out.println(<span class="string">"all of 10 tasks have committed! "</span>);  </div><div class="line">        <span class="comment">//threadPool.shutdown();        //等任务完成后，杀死线程、  </span></div><div class="line">        <span class="comment">//threadPool.shutdownNow();     //立即停止线程  </span></div><div class="line">      </div><div class="line">        <span class="comment">//用线程池启动定时器  </span></div><div class="line">          </div><div class="line">        Executors.newScheduledThreadPool(<span class="number">3</span>).schedule(  </div><div class="line">                <span class="keyword">new</span> Runnable() &#123;  <span class="comment">//任务  </span></div><div class="line">                <span class="meta">@Override</span>  </div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </div><div class="line">                    System.out.println(<span class="string">"bombing!"</span>);  </div><div class="line">                &#125;  </div><div class="line">            &#125;,   </div><div class="line">                    <span class="number">5</span>,  <span class="comment">//5秒以后执行  </span></div><div class="line">                    TimeUnit.SECONDS);  <span class="comment">//单位  </span></div><div class="line">              </div><div class="line">    <span class="comment">//在某个时间执行一次后，再指定后续的执行间隔时间  </span></div><div class="line">        Executors.newScheduledThreadPool(<span class="number">3</span>).scheduleAtFixedRate(<span class="keyword">new</span> Runnable()&#123;  </div><div class="line">  </div><div class="line">            <span class="meta">@Override</span>  </div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;           </div><div class="line">                System.out.println(<span class="string">"bombing!"</span>);  </div><div class="line">            &#125;  </div><div class="line">              </div><div class="line">        &#125;, <span class="number">10</span>,   <span class="comment">//第一次在10秒时爆炸  </span></div><div class="line">            <span class="number">3</span>,          <span class="comment">//以后每隔3秒爆炸一次。  </span></div><div class="line">        TimeUnit.SECONDS);   </div><div class="line">      </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="7-线程池的简单使用"><a href="#7-线程池的简单使用" class="headerlink" title="7. 线程池的简单使用"></a>7. 线程池的简单使用</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 一个简易的线程池管理类，提供三个线程池</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadManager</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SINGLE_POOL_NAME = <span class="string">"DEFAULT_SINGLE_POOL_NAME"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ThreadPoolProxy mLongPool = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Object mLongLock = <span class="keyword">new</span> Object();</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ThreadPoolProxy mShortPool = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Object mShortLock = <span class="keyword">new</span> Object();</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ThreadPoolProxy mDownloadPool = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Object mDownloadLock = <span class="keyword">new</span> Object();</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, ThreadPoolProxy&gt; mMap = <span class="keyword">new</span> HashMap&lt;String, ThreadPoolProxy&gt;();</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Object mSingleLock = <span class="keyword">new</span> Object();</div><div class="line"></div><div class="line">	<span class="comment">/** 获取下载线程 */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ThreadPoolProxy <span class="title">getDownloadPool</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">synchronized</span> (mDownloadLock) &#123;</div><div class="line">			<span class="keyword">if</span> (mDownloadPool == <span class="keyword">null</span>) &#123;</div><div class="line">				mDownloadPool = <span class="keyword">new</span> ThreadPoolProxy(<span class="number">3</span>, <span class="number">3</span>, <span class="number">5L</span>);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> mDownloadPool;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** 获取一个用于执行长耗时任务的线程池，避免和短耗时任务处在同一个队列而阻塞了重要的短耗时任务，通常用来联网操作 */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ThreadPoolProxy <span class="title">getLongPool</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">synchronized</span> (mLongLock) &#123;</div><div class="line">			<span class="keyword">if</span> (mLongPool == <span class="keyword">null</span>) &#123;</div><div class="line">				mLongPool = <span class="keyword">new</span> ThreadPoolProxy(<span class="number">5</span>, <span class="number">5</span>, <span class="number">5L</span>);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> mLongPool;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** 获取一个用于执行短耗时任务的线程池，避免因为和耗时长的任务处在同一个队列而长时间得不到执行，通常用来执行本地的IO/SQL */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ThreadPoolProxy <span class="title">getShortPool</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">synchronized</span> (mShortLock) &#123;</div><div class="line">			<span class="keyword">if</span> (mShortPool == <span class="keyword">null</span>) &#123;</div><div class="line">				mShortPool = <span class="keyword">new</span> ThreadPoolProxy(<span class="number">2</span>, <span class="number">2</span>, <span class="number">5L</span>);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> mShortPool;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** 获取一个单线程池，所有任务将会被按照加入的顺序执行，免除了同步开销的问题 */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ThreadPoolProxy <span class="title">getSinglePool</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> getSinglePool(DEFAULT_SINGLE_POOL_NAME);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** 获取一个单线程池，所有任务将会被按照加入的顺序执行，免除了同步开销的问题 */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ThreadPoolProxy <span class="title">getSinglePool</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">		<span class="keyword">synchronized</span> (mSingleLock) &#123;</div><div class="line">			ThreadPoolProxy singlePool = mMap.get(name);</div><div class="line">			<span class="keyword">if</span> (singlePool == <span class="keyword">null</span>) &#123;</div><div class="line">				singlePool = <span class="keyword">new</span> ThreadPoolProxy(<span class="number">1</span>, <span class="number">1</span>, <span class="number">5L</span>);</div><div class="line">				mMap.put(name, singlePool);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> singlePool;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolProxy</span> </span>&#123;</div><div class="line">		<span class="keyword">private</span> ThreadPoolExecutor mPool;</div><div class="line">		<span class="keyword">private</span> <span class="keyword">int</span> mCorePoolSize;</div><div class="line">		<span class="keyword">private</span> <span class="keyword">int</span> mMaximumPoolSize;</div><div class="line">		<span class="keyword">private</span> <span class="keyword">long</span> mKeepAliveTime;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">private</span> <span class="title">ThreadPoolProxy</span><span class="params">(<span class="keyword">int</span> corePoolSize, <span class="keyword">int</span> maximumPoolSize, <span class="keyword">long</span> keepAliveTime)</span> </span>&#123;</div><div class="line">			mCorePoolSize = corePoolSize;</div><div class="line">			mMaximumPoolSize = maximumPoolSize;</div><div class="line">			mKeepAliveTime = keepAliveTime;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/** 执行任务，当线程池处于关闭，将会重新创建新的线程池 */</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable run)</span> </span>&#123;</div><div class="line">			<span class="keyword">if</span> (run == <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (mPool == <span class="keyword">null</span> || mPool.isShutdown()) &#123;</div><div class="line">				<span class="comment">//参数说明</span></div><div class="line">				<span class="comment">//当线程池中的线程小于mCorePoolSize，直接创建新的线程加入线程池执行任务</span></div><div class="line">				<span class="comment">//当线程池中的线程数目等于mCorePoolSize，将会把任务放入任务队列BlockingQueue中</span></div><div class="line">				<span class="comment">//当BlockingQueue中的任务放满了，将会创建新的线程去执行，</span></div><div class="line">				<span class="comment">//但是当总线程数大于mMaximumPoolSize时，将会抛出异常，交给RejectedExecutionHandler处理</span></div><div class="line">				<span class="comment">//mKeepAliveTime是线程执行完任务后，且队列中没有可以执行的任务，存活的时间，后面的参数是时间单位</span></div><div class="line">				<span class="comment">//ThreadFactory是每次创建新的线程工厂</span></div><div class="line">				mPool = <span class="keyword">new</span> ThreadPoolExecutor(mCorePoolSize, mMaximumPoolSize, mKeepAliveTime, TimeUnit.MILLISECONDS, <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(), Executors.defaultThreadFactory(), <span class="keyword">new</span> AbortPolicy());</div><div class="line">			&#125;</div><div class="line">			mPool.execute(run);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/** 取消线程池中某个还未执行的任务 */</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">(Runnable run)</span> </span>&#123;</div><div class="line">			<span class="keyword">if</span> (mPool != <span class="keyword">null</span> &amp;&amp; (!mPool.isShutdown() || mPool.isTerminating())) &#123;</div><div class="line">				mPool.getQueue().remove(run);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/** 取消线程池中某个还未执行的任务 */</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Runnable run)</span> </span>&#123;</div><div class="line">			<span class="keyword">if</span> (mPool != <span class="keyword">null</span> &amp;&amp; (!mPool.isShutdown() || mPool.isTerminating())) &#123;</div><div class="line">				<span class="keyword">return</span> mPool.getQueue().contains(run);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/** 立刻关闭线程池，并且正在执行的任务也将会被中断 */</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="keyword">if</span> (mPool != <span class="keyword">null</span> &amp;&amp; (!mPool.isShutdown() || mPool.isTerminating())) &#123;</div><div class="line">				mPool.shutdownNow();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/** 平缓关闭单任务线程池，但是会确保所有已经加入的任务都将会被执行完毕才关闭 */</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="keyword">if</span> (mPool != <span class="keyword">null</span> &amp;&amp; (!mPool.isShutdown() || mPool.isTerminating())) &#123;</div><div class="line">				mPool.shutdownNow();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/多线程/" rel="tag"># 多线程</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/04/30/同步工具类/" rel="next" title="同步工具类">
                <i class="fa fa-chevron-left"></i> 同步工具类
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/04/30/线程范围内共享数据/" rel="prev" title="线程范围内共享数据">
                线程范围内共享数据 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/ai.jpg"
               alt="JackChan" />
          <p class="site-author-name" itemprop="name">JackChan</p>
           
              <p class="site-description motion-element" itemprop="description">生活不止眼前的苟且，还有诗和远方！</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/JackChan1999" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.gitbook.com/@alleniverson" target="_blank" title="GitBook">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  GitBook
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/1848214604?topnav=1&wvr=6&topsug=1&is_all=1" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.csdn.net/axi295309066" target="_blank" title="CSDN">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-Executor类的继承结构"><span class="nav-number">1.</span> <span class="nav-text">1. Executor类的继承结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-ThreadPoolExecutor"><span class="nav-number">2.</span> <span class="nav-text">2. ThreadPoolExecutor</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-构造方法"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 构造方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-1-int-corePoolSize"><span class="nav-number">2.1.1.</span> <span class="nav-text">2.1.1 int corePoolSize</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-2-int-maximumPoolSize"><span class="nav-number">2.1.2.</span> <span class="nav-text">2.1.2 int maximumPoolSize</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-3-long-keepAliveTime"><span class="nav-number">2.1.3.</span> <span class="nav-text">2.1.3 long keepAliveTime</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-4-TimeUnit-unit"><span class="nav-number">2.1.4.</span> <span class="nav-text">2.1.4 TimeUnit unit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-5-RejectedExecutionHandler"><span class="nav-number">2.1.5.</span> <span class="nav-text">2.1.5 RejectedExecutionHandler</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-任务提交给线程池之后的处理策略"><span class="nav-number">3.</span> <span class="nav-text">3. 任务提交给线程池之后的处理策略</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-阻塞队列的介绍"><span class="nav-number">4.</span> <span class="nav-text">4. 阻塞队列的介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-BlockingQueue"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 BlockingQueue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-排队策略"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 排队策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#直接提交"><span class="nav-number">4.2.1.</span> <span class="nav-text">直接提交</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#无界队列"><span class="nav-number">4.2.2.</span> <span class="nav-text">无界队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#有界队列"><span class="nav-number">4.2.3.</span> <span class="nav-text">有界队列</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-BlockingQueue"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 BlockingQueue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-BlockingDeque"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 BlockingDeque</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-ArrayBlockingQueue"><span class="nav-number">4.5.</span> <span class="nav-text">4.5 ArrayBlockingQueue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-6-LinkedBlockingQueue"><span class="nav-number">4.6.</span> <span class="nav-text">4.6 LinkedBlockingQueue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-7-SynchronousQueue"><span class="nav-number">4.7.</span> <span class="nav-text">4.7 SynchronousQueue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-8-DelayQueue"><span class="nav-number">4.8.</span> <span class="nav-text">4.8 DelayQueue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-9-PriorityBlockingQueue"><span class="nav-number">4.9.</span> <span class="nav-text">4.9 PriorityBlockingQueue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-10-生产者消费者"><span class="nav-number">4.10.</span> <span class="nav-text">4.10 生产者消费者</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-线程池工具类Executors"><span class="nav-number">5.</span> <span class="nav-text">5. 线程池工具类Executors</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-线程池"><span class="nav-number">6.</span> <span class="nav-text">6. 线程池</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-线程池的简单使用"><span class="nav-number">7.</span> <span class="nav-text">7. 线程池的简单使用</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JackChan</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://yoursite.com/2017/04/30/线程池/';
          this.page.identifier = '2017/04/30/线程池/';
          this.page.title = '线程池';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
