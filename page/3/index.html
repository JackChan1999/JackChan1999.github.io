<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="生活不止眼前的苟且，还有诗和远方！">
<meta property="og:type" content="website">
<meta property="og:title" content="秋过冬漫长">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="秋过冬漫长">
<meta property="og:description" content="生活不止眼前的苟且，还有诗和远方！">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="秋过冬漫长">
<meta name="twitter:description" content="生活不止眼前的苟且，还有诗和远方！">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>秋过冬漫长</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">秋过冬漫长</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">没有比脚更长的路，走过去，前面是个天！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/30/定时器、互斥、同步通信技术/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="JackChan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ai.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="秋过冬漫长">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/30/定时器、互斥、同步通信技术/" itemprop="url">
                  定时器、互斥、同步通信技术
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-30T23:56:42+08:00">
                2017-04-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/30/定时器、互斥、同步通信技术/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/04/30/定时器、互斥、同步通信技术/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="笔记摘要"><a href="#笔记摘要" class="headerlink" title="笔记摘要"></a><strong>笔记摘要</strong></h1><p>这里分析了多线程的一些细节问题，并介绍了传统定时器的创建，同时实现了根据自己的调度计划的自定义定时器，对于传统互斥技术中发现的内部类问题，进行了分析，最后对于同步通信技术，是重点，分析了如何处理类似的问题，如何设计能够更加清晰简单，体现了高内聚和程序的健壮性</p>
<h1 id="1-多线程的几个知识点"><a href="#1-多线程的几个知识点" class="headerlink" title="1. 多线程的几个知识点"></a><strong>1. 多线程的几个知识点</strong></h1><h2 id="1-1-为何使用实现Runnable的方式创建线程更普遍？"><a href="#1-1-为何使用实现Runnable的方式创建线程更普遍？" class="headerlink" title="1.1 为何使用实现Runnable的方式创建线程更普遍？"></a><strong>1.1 为何使用实现Runnable的方式创建线程更普遍？</strong></h2><p>new Runnable()的方式，更加体现面向对象的思想</p>
<p>通过 new Thread()创建一个线程，代码封装在runnable对象中，代码和线程独立分开来，但最终将它们组合在一起。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">  </div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// code</span></div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="1-2-获取线程名的时候，应使用currentThread-getName-方式"><a href="#1-2-获取线程名的时候，应使用currentThread-getName-方式" class="headerlink" title="1.2 获取线程名的时候，应使用currentThread().getName()方式"></a><strong>1.2 获取线程名的时候，应使用currentThread().getName()方式</strong></h2><p>因为this.getName()方式，只有在当前对象是Thread的时候可以，当我们使用runnable方式时，this代表的是runnable对象，它仅是要运行代码的宿主，而不是线程，当然编译也无法通过（没有此方法）。</p>
<h2 id="1-3-创建线程的两种传统方式的run方法执行问题"><a href="#1-3-创建线程的两种传统方式的run方法执行问题" class="headerlink" title="1.3 创建线程的两种传统方式的run方法执行问题"></a><strong>1.3 创建线程的两种传统方式的run方法执行问题</strong></h2><p>查看Thread类的run()方法的源代码，可以看到其实这两种方式都是在调用Thread对象的run()方法，如果Thread类的run()方法没有被覆盖，并且为该Thread对象设置了一个Runnable对象，该run方法会调用Runnable对象的run()方法。</p>
<p>下面是Thread类的run()方法的源码，可以看到runnable对象也是调用了Thread的run()方法。</p>
<p>当runnable对象不为null，并且有自己的run()方法，则执行自己的，如果target为null，则Thread类的run()方法什么也不执行，所以我们在创建线程的时候不直接创建Thread对象，而是创建其子类对象，目的是为了复写run方法，把要执行的代码放进去，否则该线程没有意义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Private Runnable target;  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;  </div><div class="line">            target.run();  </div><div class="line">        &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="1-4-多线程的运行"><a href="#1-4-多线程的运行" class="headerlink" title="1.4 多线程的运行"></a><strong>1.4 多线程的运行</strong></h2><p>问题1：如果在Thread子类覆盖的run()方法中编写了运行代码，也为Thread子类对象传递了一个Runnable对象，那么，线程运行时的执行代码？</p>
<p>是子类的run方法的代码？还是Runnable对象的run()方法的代码？如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 匿名内部类的方式实现的一个子类，并在构造方法中传入了一个Runnable对象</span></div><div class="line"><span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// code</span></div><div class="line">  &#125;</div><div class="line">&#125;) &#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.run();</div><div class="line">    <span class="comment">// code</span></div><div class="line">  &#125;</div><div class="line">&#125;.start();</div></pre></td></tr></table></figure>
<p>会运行子类的run方法。因为当某个对象调用start方法之后，就会去找自己对象的run方法，如果没有就会找父类的run方法，父类的run方法会找runnable运行。</p>
<p>其实就是多态的一种体现，覆盖了父类的就执行自己的，没有覆盖就去找父类的执行</p>
<p>问题2：多线程机制是否会提高程序的运行效率？</p>
<p>多线程机制并不会提高程序的运行效率，反而性能更低，因为CPU需要在不同线程之间频繁切换。</p>
<h2 id="1-5-多线程下载的误解？"><a href="#1-5-多线程下载的误解？" class="headerlink" title="1.5 多线程下载的误解？"></a><strong>1.5 多线程下载的误解？</strong></h2><p>多线程下载其实是抢了服务器的带宽，一个线程代表一个用户，每个线程分配的带宽是相等的，开启的线程多，就会分配更多的带宽，是在抢资源，而不是自己更快。</p>
<h1 id="2-传统定时器：Timer类"><a href="#2-传统定时器：Timer类" class="headerlink" title="2. 传统定时器：Timer类"></a><strong>2. 传统定时器：Timer类</strong></h1><p>定时器有两种：一种在指定时间只执行一次，另一种先在指定时间执行一次，之后每隔指定时间循环执行。</p>
<p>该示例说明了定时器的创建方式，并通过自定义定时器的方式，在一个定时器内部通过不同切换秒数，来实现在不同的间隔时间实现循环爆炸，另外还通过两个类之间的互相实现相同的效果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Date;  </div><div class="line"><span class="keyword">import</span> java.util.Timer;  </div><div class="line"><span class="keyword">import</span> java.util.TimerTask;  </div><div class="line">  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TraditionalTimerTest</span> </span>&#123;  </div><div class="line">  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </div><div class="line">          </div><div class="line">        <span class="comment">//创建一个定时器并调度任务  </span></div><div class="line">    <span class="comment">/*  new Timer().schedule(new TimerTask() &#123; </span></div><div class="line">             </div><div class="line">            @Override </div><div class="line">            public void run() &#123; </div><div class="line">                System.out.println("bombing!"); </div><div class="line">                 </div><div class="line">            &#125; </div><div class="line">        &#125;, 3000);//3秒以后爆炸 </div><div class="line">*/      <span class="comment">//&#125;, 10000,3000);       //10秒以后爆炸，以后每隔3秒炸一次  </span></div><div class="line">          </div><div class="line">          </div><div class="line">        <span class="comment">//自定义一个定时器  </span></div><div class="line">        <span class="class"><span class="keyword">class</span> <span class="title">MyTimerTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span></span>&#123;  </div><div class="line">              </div><div class="line">            <span class="meta">@Override</span>  </div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </div><div class="line">                count = (count+<span class="number">1</span>)%<span class="number">2</span>;    <span class="comment">//在0和1之间切换  </span></div><div class="line">                System.out.println(<span class="string">"bombing!"</span>);  </div><div class="line">                <span class="keyword">new</span> Timer().schedule(<span class="comment">/*new TimerTask() &#123; </span></div><div class="line">                     </div><div class="line">                    @Override </div><div class="line">                    public void run() &#123; </div><div class="line">                        System.out.println("bombing!"); </div><div class="line">                    &#125; </div><div class="line">                &#125;*/<span class="keyword">new</span> MyTimerTask(),<span class="number">2000</span>+<span class="number">2000</span>*count);  </div><div class="line">                <span class="comment">//实现循环，不能用this，因为是匿名，所以只能执行一次，  </span></div><div class="line">                <span class="comment">//就像炸弹一样，炸完后就没有了，必须布置新的炸弹  </span></div><div class="line">                <span class="comment">//所以创建一个类，每次在最后new一个新的炸弹  </span></div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">          </div><div class="line">        <span class="comment">//开启定时器，每隔2秒调用一次MyTimerTask  </span></div><div class="line">        <span class="keyword">new</span> Timer().schedule(<span class="keyword">new</span> MyTimerTask(), <span class="number">2000</span>);  </div><div class="line">          </div><div class="line">        <span class="comment">//为了观察定时器任务的执行：每隔1秒打印一次当前秒数  </span></div><div class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;  </div><div class="line">            System.out.println(<span class="keyword">new</span> Date().getSeconds());  </div><div class="line">            <span class="keyword">try</span> &#123;  </div><div class="line">                Thread.sleep(<span class="number">1000</span>);  </div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </div><div class="line">                <span class="comment">// TODO Auto-generated catch block  </span></div><div class="line">                e.printStackTrace();  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用互相调用的方式实现间隔2秒和4秒的连环爆炸<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Date;  </div><div class="line"><span class="keyword">import</span> java.util.Timer;  </div><div class="line"><span class="keyword">import</span> java.util.TimerTask;  </div><div class="line">  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTraditionalTimer</span> </span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;  </div><div class="line">          </div><div class="line">        <span class="keyword">new</span> Timer().schedule(<span class="keyword">new</span> MyTimerTask(), <span class="number">4000</span>);  </div><div class="line">          </div><div class="line">        <span class="comment">//打印当前秒数  </span></div><div class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;  </div><div class="line">            System.out.println(<span class="keyword">new</span> Date().getSeconds());  </div><div class="line">            <span class="keyword">try</span> &#123;  </div><div class="line">                Thread.sleep(<span class="number">1000</span>);  </div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </div><div class="line">                <span class="comment">// TODO Auto-generated catch block  </span></div><div class="line">                e.printStackTrace();  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line"><span class="comment">//每隔2秒调用MyTimerTask2  </span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTimerTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span></span>&#123;  </div><div class="line">      </div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="comment">// TODO Auto-generated method stub  </span></div><div class="line">        System.out.println(<span class="string">"boomping!!!"</span>);  </div><div class="line">        <span class="keyword">new</span> Timer().schedule(<span class="keyword">new</span> MyTimerTask2(),<span class="number">2000</span>);  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="comment">//每隔4秒调用MyTimerTask2  </span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTimerTask2</span> <span class="keyword">extends</span> <span class="title">TimerTask</span></span>&#123;  </div><div class="line">      </div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="comment">// TODO Auto-generated method stub  </span></div><div class="line">        System.out.println(<span class="string">"boomping!!!"</span>);  </div><div class="line">        <span class="keyword">new</span> Timer().schedule(<span class="keyword">new</span> MyTimerTask(), <span class="number">4000</span>);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="3-调度框架：quarts"><a href="#3-调度框架：quarts" class="headerlink" title="3. 调度框架：quarts"></a><strong>3. 调度框架：quarts</strong></h1><p>Quartz是一个开源的作业调度框架，它完全由Java写成，并设计用于J2SE和J2EE应用中。它提供了巨大的灵活性而不牺牲简单性。你能够用它来为执行一个作业而创建简单的或复杂的调度。它有很多特征，如：数据库支持，集群，插件，EJB作业预构建，JavaMail及其它，支持cron-like表达式等等。</p>
<p>对于定时器中不能很好实现的需求，我们可以想到quarts,这里并没有介绍其使用方式，以后开发用到，能够记起，去查资料</p>
<h1 id="4-传统线程互斥技术"><a href="#4-传统线程互斥技术" class="headerlink" title="4. 传统线程互斥技术"></a><strong>4. 传统线程互斥技术</strong></h1><p>发现的问题：在主函数内部不能创建内部类的实例对象</p>
<p>内部类的一个重要特点就是可以访问外部类的成员变量，成员变量是对象身上的，对象创建完后，成员变量才分配空间，所以内部类访问外部类的成员变量需要外部类的实例对象。而静态方法先存在，所以不可以。</p>
<p>解决方式：</p>
<p>可以将内部类定义为静态的，或者将创建内部类的实例对象的语句封装在一个外部类的成员方法中，这里定义了一个init方法，因为方法调用需要对象，这个对象就是将来调用该方法的对象</p>
<p>示例说明：</p>
<p>本示例主要是对上面的问题进行了展示，另外对过去的互斥技术中的锁所使用的对象进行了分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TraditionalThreadSychronized</span> </span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </div><div class="line">          </div><div class="line">        <span class="comment">//无法创建，必须关联一个外部类的实例对象，可以定义一个方法，  </span></div><div class="line">        <span class="comment">//或者将外部类定义为静态  </span></div><div class="line">        <span class="comment">//final Outputer outputer = new Outputer(); //编译错误  </span></div><div class="line">        <span class="keyword">new</span> TraditionalThreadSychronized().init();  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="comment">//方法需要对象调用，所以就关联了一个外部类的对象  </span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="keyword">final</span> Outputer outputer = <span class="keyword">new</span> Outputer();  </div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;  </div><div class="line">  </div><div class="line">            <span class="meta">@Override</span>  </div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </div><div class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;  </div><div class="line">                    <span class="keyword">try</span> &#123;  </div><div class="line">                        Thread.sleep(<span class="number">10</span>);  </div><div class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </div><div class="line">                        e.printStackTrace();  </div><div class="line">                    &#125;  </div><div class="line">                    outputer.output(<span class="string">"11111"</span>);  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">  </div><div class="line">        &#125;).start();  </div><div class="line">  </div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;  </div><div class="line">  </div><div class="line">            <span class="meta">@Override</span>  </div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </div><div class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;  </div><div class="line">  </div><div class="line">                    <span class="keyword">try</span> &#123;  </div><div class="line">                        Thread.sleep(<span class="number">10</span>);  </div><div class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </div><div class="line">                        e.printStackTrace();  </div><div class="line">                    &#125;  </div><div class="line">                    <span class="comment">// outputer.output("are you happy?");  </span></div><div class="line">                    outputer.output2(<span class="string">"22222"</span>);  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">        &#125;).start();  </div><div class="line">  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">     <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Outputer</span> </span>&#123;  </div><div class="line">         <span class="comment">//  </span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">output</span><span class="params">(String name)</span> </span>&#123;  </div><div class="line">            <span class="comment">// String lock = "";  </span></div><div class="line">            <span class="keyword">int</span> len = name.length();  </div><div class="line">  </div><div class="line">            <span class="comment">// synchronized(lock)&#123; 使用同一把锁，任意对象都可以  </span></div><div class="line">            <span class="comment">// synchronized(this)&#123; 同步函数使用的是锁是this，即outputer对象  </span></div><div class="line">            <span class="keyword">synchronized</span> (Outputer.class) &#123; <span class="comment">// 静态方法的锁只能是class字节码对象  </span></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;  </div><div class="line">                    System.out.print(name.charAt(i));  </div><div class="line">                &#125;  </div><div class="line">                System.out.println();  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="comment">// 同步函数使用的是锁是this  </span></div><div class="line">        <span class="comment">/* </span></div><div class="line">          public synchronized void output2(String name)&#123;  </div><div class="line">            int len = name.length(); </div><div class="line">            for(int i=0;i&lt;len;i++)&#123;  </div><div class="line">                System.out.print(name.charAt(i)); &#125; </div><div class="line">                System.out.println();  </div><div class="line">              &#125; </div><div class="line">          &#125; </div><div class="line">         */  </div><div class="line">          </div><div class="line">        <span class="comment">//定义同步的静态方法  </span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">output2</span><span class="params">(String name)</span> </span>&#123;  </div><div class="line">            <span class="keyword">int</span> len = name.length();  </div><div class="line">  </div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;  </div><div class="line">                System.out.print(name.charAt(i));  </div><div class="line">            &#125;  </div><div class="line">            System.out.println();  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="5-传统线程同步通信技术"><a href="#5-传统线程同步通信技术" class="headerlink" title="5. 传统线程同步通信技术"></a><strong>5. 传统线程同步通信技术</strong></h1><p>这里通过一道面试题进行讲解</p>
<p>需求：子线程循环10次，接着主线程循环100次，接着又回到子线程循环10次，接着再回到主线程又循环100次，如此循环50次</p>
<p>1、思路：</p>
<p> 使用面向对象的方式思考，子线程的任务是循环10次，子线程的任务是循环100次，所以可以将它们各自的任务封装起来，在封装内部实现各自的同步（锁是放在代表要操作的资源的类的内部方法中），最后别的对象来调用，循环50次即可</p>
<p>2、Eclipse小技巧：</p>
<p>这里打印结果过长，我们可以使用eclipse将打印结果输出到文件中：<br>Run As → Run Configurations → Common → File前打勾 → 指定路径</p>
<p>3、锁对象的定义</p>
<p>两个线程执行的代码片段要实现同步互斥的效果，它们必须用同一个锁对象，锁是放在代表要操作的资源的类的内部方法中，而不是在线程代码中。</p>
<p>4、实现按指定的顺序执行</p>
<p>需要用到wait，Notify，当轮到自己要执行的时候，让对象去唤醒自己，可以定义一个标识，来决定谁可以执行</p>
<p>5、wait方法必须放在synchronized的里面，而且调用它的对象必须和synchronized的对象是同一个。</p>
<p>6、While比if更严谨，因为会循环判断执行条件，所以可以防止伪唤醒，（并不是期望的对象来唤醒自己）。</p>
<p>经验：要用到共同数据（包括同步锁）或共同算法的若干个方法应该归于同一个类上，在这个类的内部去管理各个方法的状态，这种设计正好体现了高类聚和程序的健壮性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TraditionalThreadCommunication</span> </span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;  </div><div class="line">          </div><div class="line">        <span class="comment">//获取一个业务对象  </span></div><div class="line">        <span class="keyword">final</span> Business business = <span class="keyword">new</span> Business();  </div><div class="line">          </div><div class="line">        <span class="comment">//子线程  </span></div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;  </div><div class="line">  </div><div class="line">            <span class="meta">@Override</span>  </div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </div><div class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">50</span>;i++)&#123;  </div><div class="line">                    <span class="comment">/*for(int j=0;j&lt;10;j++)&#123; </span></div><div class="line">                        System.out.println("sub thread sequence of"+i+",loop of "+j); </div><div class="line">                    &#125;*/  </div><div class="line">                    business.sub(i);  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">        &#125;).start();  </div><div class="line">              </div><div class="line">            <span class="comment">//主线程  </span></div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">50</span>;i++)&#123;  </div><div class="line">                  </div><div class="line">            <span class="comment">/*  for(int j=0;j&lt;100;j++)&#123; </span></div><div class="line">                System.out.println("main thread sequence of"+i+", loop of "+j); </div><div class="line">                &#125;   */        </div><div class="line">                business.main(i);  </div><div class="line">          &#125;  </div><div class="line">       &#125;  </div><div class="line">   &#125;  </div><div class="line">  </div><div class="line"><span class="comment">//定义一个业务类  </span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Business</span></span>&#123;  </div><div class="line">      </div><div class="line">    <span class="comment">//定义一个boolean型变量来决定子线程和主线程的执行权  </span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> bShouldSub = <span class="keyword">true</span>;  </div><div class="line">      </div><div class="line">    <span class="comment">//子线程  </span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">sub</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;<span class="comment">//把同步的鎖放在资源身上  </span></div><div class="line">        <span class="comment">//不该子线程执行，等待  </span></div><div class="line">        <span class="keyword">if</span>(!bShouldSub)&#123;  </div><div class="line">            <span class="keyword">try</span> &#123;  </div><div class="line">                <span class="keyword">this</span>.wait();  </div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </div><div class="line">                <span class="comment">// TODO Auto-generated catch block  </span></div><div class="line">                e.printStackTrace();  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">          </div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=<span class="number">10</span>;j++)&#123;  </div><div class="line">            System.out.println(<span class="string">"sub thread sequence of"</span>+i+<span class="string">",loop of "</span>+j);  </div><div class="line">        &#125;  </div><div class="line">        bShouldSub = <span class="keyword">false</span>;  </div><div class="line">        <span class="keyword">this</span>.notify();      <span class="comment">//唤醒主线程  </span></div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="comment">//主线程  </span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;  </div><div class="line">          </div><div class="line">        <span class="comment">//若是子线程执行，主线程等待  </span></div><div class="line">        <span class="keyword">if</span>(bShouldSub)&#123;  </div><div class="line">            <span class="keyword">try</span> &#123;  </div><div class="line">                <span class="keyword">this</span>.wait();  </div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </div><div class="line">                <span class="comment">// TODO Auto-generated catch block  </span></div><div class="line">                e.printStackTrace();  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=<span class="number">100</span>;j++)&#123;  </div><div class="line">            System.out.println(<span class="string">"main thread sequence of"</span>+i+<span class="string">", loop of "</span>+j);  </div><div class="line">        &#125;     </div><div class="line">        bShouldSub = <span class="keyword">true</span>;  </div><div class="line">        <span class="keyword">this</span>.notify();      <span class="comment">//唤醒子线程  </span></div><div class="line">    &#125;     </div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/30/线程锁技术/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="JackChan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ai.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="秋过冬漫长">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/30/线程锁技术/" itemprop="url">
                  线程锁技术
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-30T23:56:42+08:00">
                2017-04-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/30/线程锁技术/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/04/30/线程锁技术/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="笔记摘要"><a href="#笔记摘要" class="headerlink" title="笔记摘要"></a><strong>笔记摘要</strong></h2><p>这里介绍了java5中的线程锁技术：Lock和Condition，实现线程间的通信，其中的读锁和写锁的使用通过一个缓存系统进行了演示，对于Condition的应用通过一个阻塞队列进行演示。</p>
<p>线程锁技术：Lock &amp; Condition 实现线程同步通信所属包：java.util.concurrent.locks</p>
<table>
<thead>
<tr>
<th style="text-align:left">线程锁</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Synchronized</td>
<td style="text-align:left">同步方法，锁对象是this；静态同步方法，锁对象是字节码.class；同步代码块，锁对象是任意对象，但必须是同一个对象</td>
</tr>
<tr>
<td style="text-align:left">Lock</td>
<td style="text-align:left">同步锁接口</td>
</tr>
<tr>
<td style="text-align:left">ReentrantLock</td>
<td style="text-align:left">lock()，unlock()，newCondition()</td>
</tr>
<tr>
<td style="text-align:left">ReadWriteLock</td>
<td style="text-align:left">读写锁接口</td>
</tr>
<tr>
<td style="text-align:left">ReentrantReadWriteLock</td>
<td style="text-align:left">readLock()获取读锁，writeLock()获取写锁</td>
</tr>
<tr>
<td style="text-align:left">Condition</td>
<td style="text-align:left">线程间通信  await()等待  signal()唤醒</td>
</tr>
</tbody>
</table>
<h1 id="1-Lock"><a href="#1-Lock" class="headerlink" title="1. Lock"></a><strong>1. Lock</strong></h1><p>Lock比传统线程模型中的synchronized方式更加面向对象，相对于synchronized 方法和语句它具有更广泛的锁定操作，此实现允许更灵活的结构，可以具有差别很大的属性，可以支持多个相关的 Condition 对象。 </p>
<p>于现实生活中类似，锁本身也是一个对象。两个线程执行的代码片段要实现同步互斥的结果，它们必须用同一个Lock对象，锁是上在代表要操作的资源的类的内部方法中，而不是线程代码中。</p>
<h2 id="读写锁"><a href="#读写锁" class="headerlink" title="读写锁"></a>读写锁</h2><p>分为读锁和写锁，多个读锁不互斥，读锁与写锁互斥，写锁与写锁互斥，这是由JVM自己控制的。你只要上好相应的锁即可。如果你的代码只读数据，可以很多人同时读，但不能同时写，那就上读锁；如果你的代码修改数据，只能有一个人在写，且不能同时读取，那就上写锁。总之，读的时候上读锁，写的时候上写锁！</p>
<p>读写锁的使用情景：</p>
<ul>
<li>如果代码只读数据，就可以很多人共同读取，但不能同时写。</li>
<li>如果代码修改数据，只能有一个人在写，且不能同时读数据。</li>
</ul>
<p>API中ReentrantReadWriteLock类提供的一个读写锁缓存示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CachedData</span> </span>&#123;  </div><div class="line">     </div><div class="line">　　Object data;  </div><div class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> cacheValid;  </div><div class="line">     </div><div class="line">　　ReentrantReadWriteLock rwl = <span class="keyword">new</span> ReentrantReadWriteLock();  </div><div class="line">  </div><div class="line">　　<span class="function"><span class="keyword">void</span> <span class="title">processCachedData</span><span class="params">()</span> </span>&#123;  </div><div class="line">       </div><div class="line">　　      rwl.readLock().lock();  </div><div class="line">      </div><div class="line">　　      <span class="keyword">if</span> (!cacheValid) &#123;  </div><div class="line">          </div><div class="line">　　      <span class="comment">// Must release read lock before acquiring write lock  </span></div><div class="line">          </div><div class="line">　　      rwl.readLock().unlock();  </div><div class="line">　　      rwl.writeLock().lock();  </div><div class="line">          </div><div class="line">　　     <span class="comment">// Recheck state because another thread might have acquired  </span></div><div class="line">　    　 <span class="comment">// write lock and changed state before we did.    </span></div><div class="line">　　    <span class="keyword">if</span> (!cacheValid) &#123;  </div><div class="line">            </div><div class="line">　　         data = ...       </div><div class="line">　　         cacheValid = <span class="keyword">true</span>;  </div><div class="line">          </div><div class="line">　　     &#125;  </div><div class="line">　　    <span class="comment">// Downgrade by acquiring read lock before releasing write lock  </span></div><div class="line">             rwl.readLock().lock();  </div><div class="line">          </div><div class="line">　　      rwl.writeLock().unlock(); <span class="comment">// Unlock write, still hold read  </span></div><div class="line">       </div><div class="line">　　    &#125;  </div><div class="line">　　       use(data);  </div><div class="line">　　      rwl.readLock().unlock();  </div><div class="line">     </div><div class="line">　　&#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>读写锁的应用：编写一个缓存系统</p>
<p>注解：为了避免线程的安全问题，synchronized和ReadWriteLock都可以，synchronized也防止了并发读取，性能较低有一个线程先进去，开始读取数据，进行判断，发现没有数据，其他线程就没有必要进去了，就释放读锁，加上写锁，去查找数据写入，为了避免写入的其他对象等待，再做一次判断，数据写入完成后，释放写锁，上读锁，防止写入，还原原来的状态。</p>
<p>两次判断：第一次为了写入数据，所以释放读锁，上写锁。第二次为了防止阻塞的线程重复写入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.HashMap;  </div><div class="line"><span class="keyword">import</span> java.util.Map;  </div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReadWriteLock;  </div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantReadWriteLock;  </div><div class="line">  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheDemo</span> </span>&#123;  </div><div class="line">  </div><div class="line">    <span class="comment">//定义一个map用于缓存对象  </span></div><div class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; cache = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();  </div><div class="line">          </div><div class="line">    <span class="comment">//获取一个读写锁对象  </span></div><div class="line">    <span class="keyword">private</span> ReadWriteLock rwl = <span class="keyword">new</span> ReentrantReadWriteLock();  </div><div class="line">      </div><div class="line">    <span class="comment">//带有缓存的获取指定值的方法  </span></div><div class="line">    <span class="function"><span class="keyword">public</span>  Object <span class="title">getData</span><span class="params">(String key)</span></span>&#123;  </div><div class="line">        rwl.readLock().lock();      <span class="comment">//上读锁  </span></div><div class="line">        Object value = <span class="keyword">null</span>;  </div><div class="line">        <span class="keyword">try</span>&#123;  </div><div class="line">            value = cache.get(key); <span class="comment">//获取要查询的值     </span></div><div class="line">            <span class="keyword">if</span>(value == <span class="keyword">null</span>)&#123;  <span class="comment">//线程出现安全问题的地方  </span></div><div class="line">                  </div><div class="line">                rwl.readLock().unlock();    <span class="comment">//没有数据，释放读锁，上写锁</span></div><div class="line">                <span class="comment">// 多个线程去上写锁，第一个上成功后，其他线程阻塞，第一个线程开始执行下面的代码，最后</span></div><div class="line">                <span class="comment">// 释放写锁后，后面的线程继续上写锁，为了避免后面的线程重复写入，进行二次判断</span></div><div class="line">                rwl.writeLock().lock();</div><div class="line">                <span class="keyword">try</span>&#123;  </div><div class="line">                    <span class="keyword">if</span>(value==<span class="keyword">null</span>)&#123;    <span class="comment">//二次判断，防止其他线程重复写数据  </span></div><div class="line">                            value = <span class="string">"aaaa"</span>; <span class="comment">//实际是去查询数据库  </span></div><div class="line">                    &#125;  </div><div class="line">                &#125;<span class="keyword">finally</span>&#123;  </div><div class="line">                    rwl.writeLock().unlock();   <span class="comment">//写完数据，释放写锁  </span></div><div class="line">                &#125;  </div><div class="line">                rwl.readLock().lock();  <span class="comment">//恢复读锁  </span></div><div class="line">            &#125;  </div><div class="line">        &#125;<span class="keyword">finally</span>&#123;  </div><div class="line">            rwl.readLock().unlock();    <span class="comment">//最终释放读锁  </span></div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">return</span> value;   <span class="comment">//返回获取到的值  </span></div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>虚假唤醒：用while代替if</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Lock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    lock.lock();</div><div class="line">    <span class="comment">//需要加锁的代码</span></div><div class="line">&#125;<span class="keyword">finally</span> &#123;</div><div class="line">    lock.unlock();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>读写锁测试<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadWriteLockTest</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Queue3 q3 = <span class="keyword">new</span> Queue3();</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">new</span> Thread()&#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">                    <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</div><div class="line">                        q3.get();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;.start();</div><div class="line">            <span class="keyword">new</span> Thread()&#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">                    <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</div><div class="line">                        q3.put(<span class="keyword">new</span> Random().nextInt(<span class="number">10000</span>));</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Queue3</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Object data = <span class="keyword">null</span>;</div><div class="line">ReadWriteLock rwl = <span class="keyword">new</span> ReentrantReadWriteLock</div><div class="line">();</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">()</span></span>&#123;</div><div class="line">        rwl.readLock().lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" be ready to read data!"</span>);</div><div class="line">            Thread.sleep((<span class="keyword">long</span>)(Math.random()*<span class="number">1000</span>));</div><div class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"have read data :"</span> + data);</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;<span class="keyword">finally</span>&#123;</div><div class="line">            rwl.readLock().unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object data)</span></span>&#123;</div><div class="line">        rwl.writeLock().lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" be ready to write data!"</span>);</div><div class="line">            Thread.sleep((<span class="keyword">long</span>)(Math.random()*<span class="number">1000</span>));</div><div class="line">            <span class="keyword">this</span>.data = data;</div><div class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" have write data: "</span> + data);</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;<span class="keyword">finally</span>&#123;</div><div class="line">            rwl.writeLock().unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Thread-0 be ready to read data!</div><div class="line">Thread-2 be ready to read data!</div><div class="line">Thread-4 be ready to read data!</div><div class="line">Thread-0have read data :null</div><div class="line">Thread-2have read data :null</div><div class="line">Thread-4have read data :null</div><div class="line">Thread-5 be ready to write data!</div><div class="line">Thread-5 have write data: 7975</div><div class="line">Thread-5 be ready to write data!</div><div class="line">Thread-5 have write data: 9832</div><div class="line">Thread-3 be ready to write data!</div><div class="line">Thread-3 have write data: 2813</div><div class="line">Thread-3 be ready to write data!</div><div class="line">Thread-3 have write data: 7998</div><div class="line">Thread-1 be ready to write data!</div><div class="line">Thread-1 have write data: 6737</div><div class="line">Thread-1 be ready to write data!</div><div class="line">...</div></pre></td></tr></table></figure>
<h1 id="2-Condition"><a href="#2-Condition" class="headerlink" title="2. Condition"></a><strong>2. Condition</strong></h1><p>Condition 将 Object 监视器方法（wait、notify 和 notifyAll）分解成截然不同的对象，以便通过将这些对象与任意 Lock 实现组合使用，为每个对象提供多个等待 set（wait-set）。其中，Lock 替代了 synchronized 方法和语句的使用，Condition 替代了 Object 监视器方法wait和notify的使用</p>
<p>一个锁内部可以有多个Condition，即有多路等待通知，传统的线程机制中一个监视器对象上只能有一路等待和通知，要想实现多路等待和通知，必须嵌套使用多个同步监视器对象。使用一个监视器往往会产生顾此失彼的情况。</p>
<p>在等待 Condition 时，允许发生“虚假唤醒”，这通常作为对基础平台语义的让步。对于大多数应用程序，这带来的实际影响很小，因为 Condition 应该总是在一个循环中被等待，并测试正被等待的状态声明。某个实现可以随意移除可能的虚假唤醒，但建议应用程序程序员总是假定这些虚假唤醒可能发生，因此总是在一个循环中等待。 </p>
<p>Condition的应用：阻塞队列（使用了两个监视器）</p>
<p>说明：该应用是 java.util.concurrent.locks包中Condition接口中的示例代码。使用了两个Condition分别用于管理取数据的线程，和存数据的线程，这样就可以明确的唤醒需要的一类线程，如果使用一个Condition，当队列满了之后，唤醒的并不一定就是取数据的线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoundedBuffer</span> </span>&#123;  </div><div class="line">  </div><div class="line">  <span class="keyword">final</span> Lock lock = <span class="keyword">new</span> ReentrantLock();  </div><div class="line">  <span class="keyword">final</span> Condition notFull  = lock.newCondition();   </div><div class="line">  <span class="keyword">final</span> Condition notEmpty = lock.newCondition();   </div><div class="line">  </div><div class="line">  <span class="keyword">final</span> Object[] items = <span class="keyword">new</span> Object[<span class="number">100</span>];  </div><div class="line">  <span class="keyword">int</span> putptr, takeptr, count;  </div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object x)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;  </div><div class="line">    lock.lock();  </div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">      <span class="keyword">while</span> (count == items.length) <span class="comment">//循环判断队列是否已存满  </span></div><div class="line">        notFull.await();    <span class="comment">//如果队列存满了，则要存入数据的线程等待  </span></div><div class="line">      items[putptr] = x;   </div><div class="line">      <span class="keyword">if</span> (++putptr == items.length) putptr = <span class="number">0</span>;<span class="comment">//当队列放满，指针回到0  </span></div><div class="line">      ++count;      <span class="comment">//添加了一个数据  </span></div><div class="line">      notEmpty.signal();    <span class="comment">//队列中有数据了，所以就唤醒取数据的线程  </span></div><div class="line">    &#125; <span class="keyword">finally</span> &#123;  </div><div class="line">      lock.unlock();  </div><div class="line">    &#125;  </div><div class="line">  &#125;  </div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;  </div><div class="line">    lock.lock();  </div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">      <span class="keyword">while</span> (count == <span class="number">0</span>)    <span class="comment">//循环判断，队列是否有空位  </span></div><div class="line">        notEmpty.await();   <span class="comment">//要取的线程等待  </span></div><div class="line">      Object x = items[takeptr];   </div><div class="line">      <span class="keyword">if</span> (++takeptr == items.length) takeptr = <span class="number">0</span>;  </div><div class="line">      --count;  <span class="comment">//取走一个，说明队列有空闲的位置，  </span></div><div class="line">      notFull.signal(); <span class="comment">//所以通知存入的线程  </span></div><div class="line">      <span class="keyword">return</span> x;  </div><div class="line">    &#125; <span class="keyword">finally</span> &#123;  </div><div class="line">      lock.unlock();  </div><div class="line">    &#125;  </div><div class="line">  &#125;   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Condition测试<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConditionCommunication</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Business business = <span class="keyword">new</span> Business();</div><div class="line">        <span class="keyword">new</span> Thread(</div><div class="line">                <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">5</span>;i++)&#123;</div><div class="line">                            business.sub(i);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">        ).start();</div><div class="line"></div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">5</span>;i++)&#123;</div><div class="line">            business.main(i);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    	<span class="class"><span class="keyword">class</span> <span class="title">Business</span> </span>&#123;</div><div class="line">        Lock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">        Condition condition = lock.newCondition();</div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> bShouldSub = <span class="keyword">true</span>;</div><div class="line">        <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">sub</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</div><div class="line">            lock.lock();</div><div class="line">            <span class="keyword">try</span>&#123;</div><div class="line">                <span class="keyword">while</span>(!bShouldSub)&#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        condition.await();</div><div class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=<span class="number">2</span>;j++)&#123;</div><div class="line">                  System.out.println(<span class="string">"sub thread sequence of "</span> + j + <span class="string">",loop of "</span> + i);</div><div class="line">                &#125;</div><div class="line">                bShouldSub = <span class="keyword">false</span>;</div><div class="line">                condition.signal();</div><div class="line">            &#125;<span class="keyword">finally</span>&#123;</div><div class="line">                lock.unlock();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</div><div class="line">            lock.lock();</div><div class="line">            <span class="keyword">try</span>&#123;</div><div class="line">                <span class="keyword">while</span>(bShouldSub)&#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        condition.await();</div><div class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=<span class="number">4</span>;j++)&#123;</div><div class="line">                 System.out.println(<span class="string">"main thread sequence of "</span> + j + <span class="string">",loop of "</span> + i);</div><div class="line">                &#125;</div><div class="line">                bShouldSub = <span class="keyword">true</span>;</div><div class="line">                condition.signal();</div><div class="line">            &#125;<span class="keyword">finally</span>&#123;</div><div class="line">                lock.unlock();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">sub thread sequence of 1,loop of 1</div><div class="line">sub thread sequence of 2,loop of 1</div><div class="line">main thread sequence of 1,loop of 1</div><div class="line">main thread sequence of 2,loop of 1</div><div class="line">main thread sequence of 3,loop of 1</div><div class="line">main thread sequence of 4,loop of 1</div><div class="line">sub thread sequence of 1,loop of 2</div><div class="line">sub thread sequence of 2,loop of 2</div><div class="line">main thread sequence of 1,loop of 2</div><div class="line">main thread sequence of 2,loop of 2</div><div class="line">main thread sequence of 3,loop of 2</div><div class="line">main thread sequence of 4,loop of 2</div><div class="line">sub thread sequence of 1,loop of 3</div><div class="line">sub thread sequence of 2,loop of 3</div><div class="line">main thread sequence of 1,loop of 3</div><div class="line">main thread sequence of 2,loop of 3</div><div class="line">main thread sequence of 3,loop of 3</div><div class="line">main thread sequence of 4,loop of 3</div><div class="line">sub thread sequence of 1,loop of 4</div><div class="line">sub thread sequence of 2,loop of 4</div><div class="line">main thread sequence of 1,loop of 4</div><div class="line">main thread sequence of 2,loop of 4</div><div class="line">main thread sequence of 3,loop of 4</div><div class="line">main thread sequence of 4,loop of 4</div><div class="line">sub thread sequence of 1,loop of 5</div><div class="line">sub thread sequence of 2,loop of 5</div><div class="line">main thread sequence of 1,loop of 5</div><div class="line">main thread sequence of 2,loop of 5</div><div class="line">main thread sequence of 3,loop of 5</div><div class="line">main thread sequence of 4,loop of 5</div></pre></td></tr></table></figure>
<h1 id="3-Condition练习"><a href="#3-Condition练习" class="headerlink" title="3. Condition练习"></a><strong>3. Condition练习</strong></h1><p>一共有3个线程，两个子线程先后循环2次，接着主线程循环3次，接着又回到两 个子线程先后循环2次，再回到主线程又循环3次，如此循环5次。</p>
<p>思路：老二先执行，执行完唤醒老三，老三执行完唤醒老大，老大执行完唤醒老二，以此循环，所以定义3个Condition对象和一个执行标识即可</p>
<p>示例出现的问题：两个文件中有同名类的情况</p>
<p>解决方案：可以将一个文件中的那个同名外部类放进类中，但是静态不能创建内部类的实例对象，所以需要加上static，这样两个类的名称就不一样了。 一个是原来的类名，一个是在自己类名前面加上外部类的类名。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;  </div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;  </div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;  </div><div class="line">  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreeConditionCommunication</span> </span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;  </div><div class="line">          </div><div class="line">        <span class="keyword">final</span> Business business = <span class="keyword">new</span> Business();  </div><div class="line">          </div><div class="line">　　	   <span class="comment">//创建并启动子线程老二  </span></div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;  </div><div class="line">            <span class="meta">@Override</span>  </div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </div><div class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">5</span>;i++)&#123;  </div><div class="line">                    business.sub2(i);  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">        &#125;).start();  </div><div class="line">                  </div><div class="line">　　     <span class="comment">//创建并启动子线程老三  </span></div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;  </div><div class="line">            <span class="meta">@Override</span>  </div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </div><div class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">5</span>;i++)&#123;  </div><div class="line">                    business.sub3(i);  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">        &#125;).start();  </div><div class="line">  </div><div class="line">            <span class="comment">//主线程  </span></div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">5</span>;i++)&#123;  </div><div class="line">                business.main(i);  </div><div class="line">          &#125;  </div><div class="line">       &#125;  </div><div class="line">      </div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Business</span></span>&#123;  </div><div class="line">          </div><div class="line">        Lock lock = <span class="keyword">new</span> ReentrantLock();   </div><div class="line">        Condition condition1 = lock.newCondition();  </div><div class="line">        Condition condition2 = lock.newCondition();  </div><div class="line">        Condition condition3 = lock.newCondition();  </div><div class="line">          </div><div class="line">        <span class="comment">//定义一个变量来决定线程的执行权  </span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> ShouldSub = <span class="number">1</span>;  </div><div class="line">          </div><div class="line">        <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span>  <span class="title">sub2</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;  </div><div class="line">            <span class="comment">//上锁，不让其他线程执行  </span></div><div class="line">            lock.lock();  </div><div class="line">            <span class="keyword">try</span>&#123;  </div><div class="line">            <span class="keyword">if</span>(ShouldSub != <span class="number">2</span>)&#123; <span class="comment">//如果不该老二执行，就等待  </span></div><div class="line">                <span class="keyword">try</span> &#123;  </div><div class="line">                    condition2.await();  </div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </div><div class="line">                    e.printStackTrace();  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">              </div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=<span class="number">2</span>;j++)&#123;  </div><div class="line">                System.out.println(<span class="string">"sub thread sequence of"</span>+i+<span class="string">",loop of "</span>+j);  </div><div class="line">            &#125;  </div><div class="line">            ShouldSub = <span class="number">3</span>;  <span class="comment">//准备让老三执行  </span></div><div class="line">            condition3.signal();        <span class="comment">//唤醒老三  </span></div><div class="line">            &#125;<span class="keyword">finally</span>&#123;  </div><div class="line">                lock.unlock();  </div><div class="line">            &#125;     </div><div class="line">        &#125;  </div><div class="line">          </div><div class="line">        <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span>  <span class="title">sub3</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;  </div><div class="line">              </div><div class="line">            lock.lock();  </div><div class="line">            <span class="keyword">try</span>&#123;  </div><div class="line">            <span class="keyword">if</span>(ShouldSub != <span class="number">3</span>)&#123;  </div><div class="line">                <span class="keyword">try</span> &#123;  </div><div class="line">                    condition3.await();  </div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </div><div class="line">                    e.printStackTrace();  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">              </div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=<span class="number">2</span>;j++)&#123;  </div><div class="line">                System.out.println(<span class="string">"sub2 thread sequence of"</span>+i+<span class="string">",loop of "</span>+j);  </div><div class="line">            &#125;  </div><div class="line">                ShouldSub = <span class="number">1</span>;  <span class="comment">//准备让老大执行  </span></div><div class="line">                condition1.signal();        <span class="comment">//唤醒老大  </span></div><div class="line">            &#125;<span class="keyword">finally</span>&#123;  </div><div class="line">                lock.unlock();  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">          </div><div class="line">　　    <span class="comment">//主线程  </span></div><div class="line">        <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;  </div><div class="line">              </div><div class="line">            lock.lock();  </div><div class="line">            <span class="keyword">try</span>&#123;  </div><div class="line">            <span class="keyword">if</span>(ShouldSub!=<span class="number">1</span>)&#123;  </div><div class="line">                <span class="keyword">try</span> &#123;  </div><div class="line">                    condition1.await();  </div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </div><div class="line">                    e.printStackTrace();  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=<span class="number">3</span>;j++)&#123;  </div><div class="line">                System.out.println(<span class="string">"main thread sequence of"</span>+i+<span class="string">", loop of "</span>+j);  </div><div class="line">            &#125;     </div><div class="line">            ShouldSub = <span class="number">2</span>;  <span class="comment">//准备让老二执行  </span></div><div class="line">            condition2.signal();        <span class="comment">//唤醒老二  </span></div><div class="line">            &#125;<span class="keyword">finally</span>&#123;  </div><div class="line">                lock.unlock();  </div><div class="line">            &#125;     </div><div class="line">        &#125;     </div><div class="line">    &#125;  </div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>输出结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">main thread sequence of1, loop of 1</div><div class="line">main thread sequence of1, loop of 2</div><div class="line">main thread sequence of1, loop of 3</div><div class="line">sub thread sequence of1,loop of 1</div><div class="line">sub thread sequence of1,loop of 2</div><div class="line">sub2 thread sequence of1,loop of 1</div><div class="line">sub2 thread sequence of1,loop of 2</div><div class="line">main thread sequence of2, loop of 1</div><div class="line">main thread sequence of2, loop of 2</div><div class="line">main thread sequence of2, loop of 3</div><div class="line">sub thread sequence of2,loop of 1</div><div class="line">sub thread sequence of2,loop of 2</div><div class="line">sub2 thread sequence of2,loop of 1</div><div class="line">sub2 thread sequence of2,loop of 2</div><div class="line">main thread sequence of3, loop of 1</div><div class="line">main thread sequence of3, loop of 2</div><div class="line">main thread sequence of3, loop of 3</div><div class="line">sub thread sequence of3,loop of 1</div><div class="line">sub thread sequence of3,loop of 2</div><div class="line">sub2 thread sequence of3,loop of 1</div><div class="line">sub2 thread sequence of3,loop of 2</div><div class="line">main thread sequence of4, loop of 1</div><div class="line">main thread sequence of4, loop of 2</div><div class="line">main thread sequence of4, loop of 3</div><div class="line">sub thread sequence of4,loop of 1</div><div class="line">sub thread sequence of4,loop of 2</div><div class="line">sub2 thread sequence of4,loop of 1</div><div class="line">sub2 thread sequence of4,loop of 2</div><div class="line">main thread sequence of5, loop of 1</div><div class="line">main thread sequence of5, loop of 2</div><div class="line">main thread sequence of5, loop of 3</div><div class="line">sub thread sequence of5,loop of 1</div><div class="line">sub thread sequence of5,loop of 2</div><div class="line">sub2 thread sequence of5,loop of 1</div><div class="line">sub2 thread sequence of5,loop of 2</div></pre></td></tr></table></figure></p>
<h2 id="多路等待和通知"><a href="#多路等待和通知" class="headerlink" title="多路等待和通知"></a>多路等待和通知</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoundedBuffer</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">    <span class="keyword">final</span> Condition notFull  = lock.newCondition();</div><div class="line">    <span class="keyword">final</span> Condition notEmpty = lock.newCondition();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> Object[] items = <span class="keyword">new</span> Object[<span class="number">100</span>];</div><div class="line">    <span class="keyword">int</span> putptr, takeptr, count;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object x)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (count == items.length)</div><div class="line">                notFull.await();</div><div class="line">            items[putptr] = x;</div><div class="line">            <span class="keyword">if</span> (++putptr == items.length) putptr = <span class="number">0</span>;</div><div class="line">            ++count;</div><div class="line">            notEmpty.signal();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (count == <span class="number">0</span>)</div><div class="line">                notEmpty.await();</div><div class="line">            Object x = items[takeptr];</div><div class="line">            <span class="keyword">if</span> (++takeptr == items.length) takeptr = <span class="number">0</span>;</div><div class="line">            --count;</div><div class="line">            notFull.signal();</div><div class="line">            <span class="keyword">return</span> x;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/30/volatile关键字解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="JackChan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ai.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="秋过冬漫长">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/30/volatile关键字解析/" itemprop="url">
                  volatile关键字解析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-30T23:56:42+08:00">
                2017-04-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/30/volatile关键字解析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/04/30/volatile关键字解析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>原文链接：<a href="http://www.cnblogs.com/dolphin0520/p/3920373.html" target="_blank" rel="external">http://www.cnblogs.com/dolphin0520/p/3920373.html</a></p>
</blockquote>
<p>volatile这个关键字可能很多朋友都听说过，或许也都用过。在Java 5之前，它是一个备受争议的关键字，因为在程序中使用它往往会导致出人意料的结果。在Java 5之后，volatile关键字才得以重获生机。</p>
<p>volatile关键字虽然从字面上理解起来比较简单，但是要用好不是一件容易的事情。由于volatile关键字是与Java的内存模型有关的，因此在讲述volatile关键之前，我们先来了解一下与内存模型相关的概念和知识，然后分析了volatile关键字的实现原理，最后给出了几个使用volatile关键字的场景。</p>
<h1 id="目录大纲"><a href="#目录大纲" class="headerlink" title="目录大纲"></a>目录大纲</h1><ul>
<li>内存模型的相关概念</li>
<li>并发编程中的三个概念</li>
<li>Java内存模型</li>
<li>深入剖析volatile关键字</li>
<li>使用volatile关键字的场景</li>
</ul>
<h1 id="1-内存模型的相关概念"><a href="#1-内存模型的相关概念" class="headerlink" title="1. 内存模型的相关概念"></a>1. 内存模型的相关概念</h1><p>大家都知道，计算机在执行程序时，每条指令都是在CPU中执行的，而执行指令过程中，势必涉及到数据的读取和写入。由于程序运行过程中的临时数据是存放在主存（物理内存）当中的，这时就存在一个问题，由于CPU执行速度很快，而从内存读取数据和向内存写入数据的过程跟CPU执行指令的速度比起来要慢的多，因此如果任何时候对数据的操作都要通过和内存的交互来进行，会大大降低指令执行的速度。因此在CPU里面就有了高速缓存。</p>
<p>也就是，当程序在运行过程中，会将运算需要的数据从主存复制一份到CPU的高速缓存当中，那么CPU进行计算时就可以直接从它的高速缓存读取数据和向其中写入数据，当运算结束之后，再将高速缓存中的数据刷新到主存当中。举个简单的例子，比如下面的这段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">i = i + <span class="number">1</span>;</div></pre></td></tr></table></figure>
<p>当线程执行这个语句时，会先从主存当中读取i的值，然后复制一份到高速缓存当中，然后CPU执行指令对i进行加1操作，然后将数据写入高速缓存，最后将高速缓存中i最新的值刷新到主存当中。</p>
<p>这个代码在单线程中运行是没有任何问题的，但是在多线程中运行就会有问题了。在多核CPU中，每条线程可能运行于不同的CPU中，因此每个线程运行时有自己的高速缓存（对单核CPU来说，其实也会出现这种问题，只不过是以线程调度的形式来分别执行的）。本文我们以多核CPU为例。</p>
<p>比如同时有2个线程执行这段代码，假如初始时i的值为0，那么我们希望两个线程执行完之后i的值变为2。但是事实会是这样吗？</p>
<p>可能存在下面一种情况：初始时，两个线程分别读取i的值存入各自所在的CPU的高速缓存当中，然后线程1进行加1操作，然后把i的最新值1写入到内存。此时线程2的高速缓存当中i的值还是0，进行加1操作之后，i的值为1，然后线程2把i的值写入内存。</p>
<p>最终结果i的值是1，而不是2。这就是著名的缓存一致性问题。通常称这种被多个线程访问的变量为共享变量。</p>
<p>也就是说，如果一个变量在多个CPU中都存在缓存（一般在多线程编程时才会出现），那么就可能存在缓存不一致的问题。</p>
<p>为了解决缓存不一致性问题，通常来说有以下2种解决方法：</p>
<ul>
<li>通过在总线加LOCK锁的方式</li>
<li>通过缓存一致性协议</li>
</ul>
<p>这2种方式都是硬件层面上提供的方式。</p>
<p>在早期的CPU当中，是通过在总线上加LOCK锁的形式来解决缓存不一致的问题。因为CPU和其他部件进行通信都是通过总线来进行的，如果对总线加LOCK锁的话，也就是说阻塞了其他CPU对其他部件访问（如内存），从而使得只能有一个CPU能使用这个变量的内存。比如上面例子中 如果一个线程在执行 i = i +1，如果在执行这段代码的过程中，在总线上发出了LCOK锁的信号，那么只有等待这段代码完全执行完毕之后，其他CPU才能从变量i所在的内存读取变量，然后进行相应的操作。这样就解决了缓存不一致的问题。</p>
<p>但是上面的方式会有一个问题，由于在锁住总线期间，其他CPU无法访问内存，导致效率低下。</p>
<p>所以就出现了缓存一致性协议。最出名的就是Intel 的MESI协议，MESI协议保证了每个缓存中使用的共享变量的副本是一致的。它核心的思想是：当CPU写数据时，如果发现操作的变量是共享变量，即在其他CPU中也存在该变量的副本，会发出信号通知其他CPU将该变量的缓存行置为无效状态，因此当其他CPU需要读取这个变量时，发现自己缓存中缓存该变量的缓存行是无效的，那么它就会从内存重新读取。</p>
<p><img src="http://images.cnitblog.com/blog/288799/201408/212219343783699.jpg" alt="内存模型"></p>
<h1 id="2-并发编程中的三个概念"><a href="#2-并发编程中的三个概念" class="headerlink" title="2. 并发编程中的三个概念"></a>2. 并发编程中的三个概念</h1><p>在并发编程中，我们通常会遇到以下三个问题：原子性问题，可见性问题，有序性问题。我们先看具体看一下这三个概念：</p>
<h2 id="2-1-原子性"><a href="#2-1-原子性" class="headerlink" title="2.1 原子性"></a>2.1 原子性</h2><p>原子性：即一个操作或者多个操作 要么全部执行并且执行的过程不会被任何因素打断，要么就都不执行。</p>
<p>一个很经典的例子就是银行账户转账问题：</p>
<p>比如从账户A向账户B转1000元，那么必然包括2个操作：从账户A减去1000元，往账户B加上1000元。</p>
<p>试想一下，如果这2个操作不具备原子性，会造成什么样的后果。假如从账户A减去1000元之后，操作突然中止。然后又从B取出了500元，取出500元之后，再执行 往账户B加上1000元 的操作。这样就会导致账户A虽然减去了1000元，但是账户B没有收到这个转过来的1000元。</p>
<p>所以这2个操作必须要具备原子性才能保证不出现一些意外的问题。</p>
<p>同样地反映到并发编程中会出现什么结果呢？</p>
<p>举个最简单的例子，大家想一下假如为一个32位的变量赋值过程不具备原子性的话，会发生什么后果？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">i = <span class="number">9</span>;</div></pre></td></tr></table></figure>
<p>假若一个线程执行到这个语句时，我暂且假设为一个32位的变量赋值包括两个过程：为低16位赋值，为高16位赋值。</p>
<p>那么就可能发生一种情况：当将低16位数值写入之后，突然被中断，而此时又有一个线程去读取i的值，那么读取到的就是错误的数据。</p>
<h2 id="2-2-可见性"><a href="#2-2-可见性" class="headerlink" title="2.2 可见性"></a>2.2 可见性</h2><p>可见性是指当多个线程访问同一个变量时，一个线程修改了这个变量的值，其他线程能够立即看得到修改的值。</p>
<p>举个简单的例子，看下面这段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//线程1执行的代码</span></div><div class="line"><span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">i = <span class="number">10</span>;</div><div class="line"> </div><div class="line"><span class="comment">//线程2执行的代码</span></div><div class="line">j = i;</div></pre></td></tr></table></figure>
<p>假若执行线程1的是CPU1，执行线程2的是CPU2。由上面的分析可知，当线程1执行 i =10这句时，会先把i的初始值加载到CPU1的高速缓存中，然后赋值为10，那么在CPU1的高速缓存当中i的值变为10了，却没有立即写入到主存当中。</p>
<p>此时线程2执行 j = i，它会先去主存读取i的值并加载到CPU2的缓存当中，注意此时内存当中i的值还是0，那么就会使得j的值为0，而不是10.</p>
<p>这就是可见性问题，线程1对变量i修改了之后，线程2没有立即看到线程1修改的值。</p>
<h2 id="2-3-有序性"><a href="#2-3-有序性" class="headerlink" title="2.3 有序性"></a>2.3 有序性</h2><p>有序性：即程序执行的顺序按照代码的先后顺序执行。举个简单的例子，看下面这段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> i = <span class="number">0</span>;              </div><div class="line"><span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</div><div class="line">i = <span class="number">1</span>;                <span class="comment">//语句1  </span></div><div class="line">flag = <span class="keyword">true</span>;          <span class="comment">//语句2</span></div></pre></td></tr></table></figure>
<p>上面代码定义了一个int型变量，定义了一个boolean类型变量，然后分别对两个变量进行赋值操作。从代码顺序上看，语句1是在语句2前面的，那么JVM在真正执行这段代码的时候会保证语句1一定会在语句2前面执行吗？不一定，为什么呢？这里可能会发生指令重排序（Instruction Reorder）。</p>
<p>下面解释一下什么是指令重排序，一般来说，处理器为了提高程序运行效率，可能会对输入代码进行优化，它不保证程序中各个语句的执行先后顺序同代码中的顺序一致，但是它会保证程序最终执行结果和代码顺序执行的结果是一致的。</p>
<p>比如上面的代码中，语句1和语句2谁先执行对最终的程序结果并没有影响，那么就有可能在执行过程中，语句2先执行而语句1后执行。</p>
<p>但是要注意，虽然处理器会对指令进行重排序，但是它会保证程序最终结果会和代码顺序执行结果相同，那么它靠什么保证的呢？再看下面一个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> a = <span class="number">10</span>;    <span class="comment">//语句1</span></div><div class="line"><span class="keyword">int</span> r = <span class="number">2</span>;    <span class="comment">//语句2</span></div><div class="line">a = a + <span class="number">3</span>;    <span class="comment">//语句3</span></div><div class="line">r = a*a;     <span class="comment">//语句4</span></div></pre></td></tr></table></figure>
<p>这段代码有4个语句，那么可能的一个执行顺序是：</p>
<p><img src="http://images.cnitblog.com/blog/288799/201408/212305263939989.jpg" alt="img"></p>
<p>那么可不可能是这个执行顺序呢： 语句2   语句1    语句4   语句3</p>
<p>不可能，因为处理器在进行重排序时是会考虑指令之间的数据依赖性，如果一个指令Instruction 2必须用到Instruction 1的结果，那么处理器会保证Instruction 1会在Instruction 2之前执行。</p>
<p>虽然重排序不会影响单个线程内程序执行的结果，但是多线程呢？下面看一个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//线程1:</span></div><div class="line">context = loadContext();   <span class="comment">//语句1</span></div><div class="line">inited = <span class="keyword">true</span>;             <span class="comment">//语句2</span></div><div class="line"> </div><div class="line"><span class="comment">//线程2:</span></div><div class="line"><span class="keyword">while</span>(!inited )&#123;</div><div class="line">  sleep()</div><div class="line">&#125;</div><div class="line">doSomethingwithconfig(context);</div></pre></td></tr></table></figure>
<p>上面代码中，由于语句1和语句2没有数据依赖性，因此可能会被重排序。假如发生了重排序，在线程1执行过程中先执行语句2，而此是线程2会以为初始化工作已经完成，那么就会跳出while循环，去执行doSomethingwithconfig(context)方法，而此时context并没有被初始化，就会导致程序出错。</p>
<p>从上面可以看出，指令重排序不会影响单个线程的执行，但是会影响到线程并发执行的正确性。</p>
<p>也就是说，要想并发程序正确地执行，必须要保证原子性、可见性以及有序性。只要有一个没有被保证，就有可能会导致程序运行不正确。</p>
<h1 id="3-Java内存模型"><a href="#3-Java内存模型" class="headerlink" title="3. Java内存模型"></a>3. Java内存模型</h1><p>在前面谈到了一些关于内存模型以及并发编程中可能会出现的一些问题。下面我们来看一下Java内存模型，研究一下Java内存模型为我们提供了哪些保证以及在java中提供了哪些方法和机制来让我们在进行多线程编程时能够保证程序执行的正确性。</p>
<p>在Java虚拟机规范中试图定义一种Java内存模型（Java Memory Model，JMM）来屏蔽各个硬件平台和操作系统的内存访问差异，以实现让Java程序在各种平台下都能达到一致的内存访问效果。那么Java内存模型规定了哪些东西呢，它定义了程序中变量的访问规则，往大一点说是定义了程序执行的次序。注意，为了获得较好的执行性能，Java内存模型并没有限制执行引擎使用处理器的寄存器或者高速缓存来提升指令执行速度，也没有限制编译器对指令进行重排序。也就是说，在java内存模型中，也会存在缓存一致性问题和指令重排序的问题。</p>
<p>Java内存模型规定所有的变量都是存在主存当中（类似于前面说的物理内存），每个线程都有自己的工作内存（类似于前面的高速缓存）。线程对变量的所有操作都必须在工作内存中进行，而不能直接对主存进行操作。并且每个线程不能访问其他线程的工作内存。</p>
<p>举个简单的例子：在java中，执行下面这个语句：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">i = <span class="number">10</span>;</div></pre></td></tr></table></figure>
<p>执行线程必须先在自己的工作线程中对变量i所在的缓存行进行赋值操作，然后再写入主存当中。而不是直接将数值10写入主存当中。</p>
<p>那么Java语言 本身对 原子性、可见性以及有序性提供了哪些保证呢？</p>
<h1 id="4-原子性"><a href="#4-原子性" class="headerlink" title="4. 原子性"></a>4. 原子性</h1><p>在Java中，对基本数据类型的变量的读取和赋值操作是原子性操作，即这些操作是不可被中断的，要么执行，要么不执行。上面一句话虽然看起来简单，但是理解起来并不是那么容易。看下面一个例子i：</p>
<p>请分析以下哪些操作是原子性操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">x = <span class="number">10</span>;         <span class="comment">//语句1</span></div><div class="line">y = x;         <span class="comment">//语句2</span></div><div class="line">x++;           <span class="comment">//语句3</span></div><div class="line">x = x + <span class="number">1</span>;     <span class="comment">//语句4</span></div></pre></td></tr></table></figure>
<p>咋一看，有些朋友可能会说上面的4个语句中的操作都是原子性操作。其实只有语句1是原子性操作，其他三个语句都不是原子性操作。</p>
<p>语句1是直接将数值10赋值给x，也就是说线程执行这个语句的会直接将数值10写入到工作内存中。</p>
<p>语句2实际上包含2个操作，它先要去读取x的值，再将x的值写入工作内存，虽然读取x的值以及 将x的值写入工作内存 这2个操作都是原子性操作，但是合起来就不是原子性操作了。</p>
<p>同样的，x++和 x = x+1包括3个操作：读取x的值，进行加1操作，写入新的值。</p>
<p>所以上面4个语句只有语句1的操作具备原子性。</p>
<p>也就是说，只有简单的读取、赋值（而且必须是将数字赋值给某个变量，变量之间的相互赋值不是原子操作）才是原子操作。</p>
<p>不过这里有一点需要注意：在32位平台下，对64位数据的读取和赋值是需要通过两个操作来完成的，不能保证其原子性。但是好像在最新的JDK中，JVM已经保证对64位数据的读取和赋值也是原子性操作了。</p>
<p>从上面可以看出，Java内存模型只保证了基本读取和赋值是原子性操作，如果要实现更大范围操作的原子性，可以通过synchronized和Lock来实现。由于synchronized和Lock能够保证任一时刻只有一个线程执行该代码块，那么自然就不存在原子性问题了，从而保证了原子性。</p>
<h1 id="5-可见性"><a href="#5-可见性" class="headerlink" title="5. 可见性"></a>5. 可见性</h1><p>对于可见性，Java提供了volatile关键字来保证可见性。</p>
<p>当一个共享变量被volatile修饰时，它会保证修改的值会立即被更新到主存，当有其他线程需要读取时，它会去内存中读取新值。</p>
<p>而普通的共享变量不能保证可见性，因为普通共享变量被修改之后，什么时候被写入主存是不确定的，当其他线程去读取时，此时内存中可能还是原来的旧值，因此无法保证可见性。</p>
<p>另外，通过synchronized和Lock也能够保证可见性，synchronized和Lock能保证同一时刻只有一个线程获取锁然后执行同步代码，并且在释放锁之前会将对变量的修改刷新到主存当中。因此可以保证可见性。</p>
<h1 id="6-有序性"><a href="#6-有序性" class="headerlink" title="6. 有序性"></a>6. 有序性</h1><p>在Java内存模型中，允许编译器和处理器对指令进行重排序，但是重排序过程不会影响到单线程程序的执行，却会影响到多线程并发执行的正确性。</p>
<p>在Java里面，可以通过volatile关键字来保证一定的“有序性”（具体原理在下一节讲述）。另外可以通过synchronized和Lock来保证有序性，很显然，synchronized和Lock保证每个时刻是有一个线程执行同步代码，相当于是让线程顺序执行同步代码，自然就保证了有序性。</p>
<p>另外，Java内存模型具备一些先天的“有序性”，即不需要通过任何手段就能够得到保证的有序性，这个通常也称为 happens-before 原则。如果两个操作的执行次序无法从happens-before原则推导出来，那么它们就不能保证它们的有序性，虚拟机可以随意地对它们进行重排序。</p>
<p>下面就来具体介绍下happens-before原则（先行发生原则）：</p>
<ul>
<li>程序次序规则：一个线程内，按照代码顺序，书写在前面的操作先行发生于书写在后面的操作</li>
<li>锁定规则：一个unLock操作先行发生于后面对同一个锁额lock操作</li>
<li>volatile变量规则：对一个变量的写操作先行发生于后面对这个变量的读操作</li>
<li>传递规则：如果操作A先行发生于操作B，而操作B又先行发生于操作C，则可以得出操作A先行发生于操作C</li>
<li>线程启动规则：Thread对象的start()方法先行发生于此线程的每个一个动作</li>
<li>线程中断规则：对线程interrupt()方法的调用先行发生于被中断线程的代码检测到中断事件的发生</li>
<li>线程终结规则：线程中所有的操作都先行发生于线程的终止检测，我们可以通过Thread.join()方法结束、Thread.isAlive()的返回值手段检测到线程已经终止执行</li>
<li>对象终结规则：一个对象的初始化完成先行发生于他的finalize()方法的开始</li>
</ul>
<p>这8条原则摘自《深入理解Java虚拟机》。这8条规则中，前4条规则是比较重要的，后4条规则都是显而易见的。下面我们来解释一下前4条规则：</p>
<p>对于程序次序规则来说，我的理解就是一段程序代码的执行在单个线程中看起来是有序的。注意，虽然这条规则中提到“书写在前面的操作先行发生于书写在后面的操作”，这个应该是程序看起来执行的顺序是按照代码顺序执行的，因为虚拟机可能会对程序代码进行指令重排序。虽然进行重排序，但是最终执行的结果是与程序顺序执行的结果一致的，它只会对不存在数据依赖性的指令进行重排序。因此，在单个线程中，程序执行看起来是有序执行的，这一点要注意理解。事实上，这个规则是用来保证程序在单线程中执行结果的正确性，但无法保证程序在多线程中执行的正确性。</p>
<p>第二条规则也比较容易理解，也就是说无论在单线程中还是多线程中，同一个锁如果出于被锁定的状态，那么必须先对锁进行了释放操作，后面才能继续进行lock操作。</p>
<p>第三条规则是一条比较重要的规则，也是后文将要重点讲述的内容。直观地解释就是，如果一个线程先去写一个变量，然后一个线程去进行读取，那么写入操作肯定会先行发生于读操作。</p>
<p>第四条规则实际上就是体现happens-before原则具备传递性。</p>
<h1 id="7-深入剖析volatile关键字"><a href="#7-深入剖析volatile关键字" class="headerlink" title="7. 深入剖析volatile关键字"></a>7. 深入剖析volatile关键字</h1><p>在前面讲述了很多东西，其实都是为讲述volatile关键字作铺垫，那么接下来我们就进入主题。</p>
<h2 id="7-1-volatile关键字的两层语义"><a href="#7-1-volatile关键字的两层语义" class="headerlink" title="7.1 volatile关键字的两层语义"></a>7.1 volatile关键字的两层语义</h2><p>一旦一个共享变量（类的成员变量、类的静态成员变量）被volatile修饰之后，那么就具备了两层语义：</p>
<ul>
<li>保证了不同线程对这个变量进行操作时的可见性，即一个线程修改了某个变量的值，这新值对其他线程来说是立即可见的。</li>
<li>禁止进行指令重排序。</li>
</ul>
<p>先看一段代码，假如线程1先执行，线程2后执行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//线程1</span></div><div class="line"><span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</div><div class="line"><span class="keyword">while</span>(!stop)&#123;</div><div class="line">    doSomething();</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">//线程2</span></div><div class="line">stop = <span class="keyword">true</span>;</div></pre></td></tr></table></figure>
<p>这段代码是很典型的一段代码，很多人在中断线程时可能都会采用这种标记办法。但是事实上，这段代码会完全运行正确么？即一定会将线程中断么？不一定，也许在大多数时候，这个代码能够把线程中断，但是也有可能会导致无法中断线程（虽然这个可能性很小，但是只要一旦发生这种情况就会造成死循环了）。</p>
<p>下面解释一下这段代码为何有可能导致无法中断线程。在前面已经解释过，每个线程在运行过程中都有自己的工作内存，那么线程1在运行的时候，会将stop变量的值拷贝一份放在自己的工作内存当中。</p>
<p>那么当线程2更改了stop变量的值之后，但是还没来得及写入主存当中，线程2转去做其他事情了，那么线程1由于不知道线程2对stop变量的更改，因此还会一直循环下去。</p>
<p>但是用volatile修饰之后就变得不一样了：</p>
<p>第一：使用volatile关键字会强制将修改的值立即写入主存；</p>
<p>第二：使用volatile关键字的话，当线程2进行修改时，会导致线程1的工作内存中缓存变量stop的缓存行无效（反映到硬件层的话，就是CPU的L1或者L2缓存中对应的缓存行无效）；</p>
<p>第三：由于线程1的工作内存中缓存变量stop的缓存行无效，所以线程1再次读取变量stop的值时会去主存读取。</p>
<p>那么在线程2修改stop值时（当然这里包括2个操作，修改线程2工作内存中的值，然后将修改后的值写入内存），会使得线程1的工作内存中缓存变量stop的缓存行无效，然后线程1读取时，发现自己的缓存行无效，它会等待缓存行对应的主存地址被更新之后，然后去对应的主存读取最新的值。</p>
<p>那么线程1读取到的就是最新的正确的值。</p>
<h2 id="7-2-volatile保证原子性吗？"><a href="#7-2-volatile保证原子性吗？" class="headerlink" title="7.2 volatile保证原子性吗？"></a>7.2 volatile保证原子性吗？</h2><p>从上面知道volatile关键字保证了操作的可见性，但是volatile能保证对变量的操作是原子性吗？</p>
<p>下面看一个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">int</span> inc = <span class="number">0</span>;</div><div class="line">     </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span> </span>&#123;</div><div class="line">        inc++;</div><div class="line">    &#125;</div><div class="line">     </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Test test = <span class="keyword">new</span> Test();</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</div><div class="line">            <span class="keyword">new</span> Thread()&#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">1000</span>;j++)</div><div class="line">                        test.increase();</div><div class="line">                &#125;;</div><div class="line">            &#125;.start();</div><div class="line">        &#125;</div><div class="line">         </div><div class="line">        <span class="keyword">while</span>(Thread.activeCount()&gt;<span class="number">1</span>)  <span class="comment">//保证前面的线程都执行完</span></div><div class="line">            Thread.yield();</div><div class="line">        System.out.println(test.inc);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>大家想一下这段程序的输出结果是多少？也许有些朋友认为是10000。但是事实上运行它会发现每次运行结果都不一致，都是一个小于10000的数字。</p>
<p>可能有的朋友就会有疑问，不对啊，上面是对变量inc进行自增操作，由于volatile保证了可见性，那么在每个线程中对inc自增完之后，在其他线程中都能看到修改后的值啊，所以有10个线程分别进行了1000次操作，那么最终inc的值应该是1000*10=10000。</p>
<p>这里面就有一个误区了，volatile关键字能保证可见性没有错，但是上面的程序错在没能保证原子性。可见性只能保证每次读取的是最新的值，但是volatile没办法保证对变量的操作的原子性。</p>
<p>在前面已经提到过，自增操作是不具备原子性的，它包括读取变量的原始值、进行加1操作、写入工作内存。那么就是说自增操作的三个子操作可能会分割开执行，就有可能导致下面这种情况出现：</p>
<p>假如某个时刻变量inc的值为10，</p>
<p>线程1对变量进行自增操作，线程1先读取了变量inc的原始值，然后线程1被阻塞了；</p>
<p>然后线程2对变量进行自增操作，线程2也去读取变量inc的原始值，由于线程1只是对变量inc进行读取操作，而没有对变量进行修改操作，所以不会导致线程2的工作内存中缓存变量inc的缓存行无效，所以线程2会直接去主存读取inc的值，发现inc的值时10，然后进行加1操作，并把11写入工作内存，最后写入主存。</p>
<p>然后线程1接着进行加1操作，由于已经读取了inc的值，注意此时在线程1的工作内存中inc的值仍然为10，所以线程1对inc进行加1操作后inc的值为11，然后将11写入工作内存，最后写入主存。</p>
<p>那么两个线程分别进行了一次自增操作后，inc只增加了1。</p>
<p>解释到这里，可能有朋友会有疑问，不对啊，前面不是保证一个变量在修改volatile变量时，会让缓存行无效吗？然后其他线程去读就会读到新的值，对，这个没错。这个就是上面的happens-before规则中的volatile变量规则，但是要注意，线程1对变量进行读取操作之后，被阻塞了的话，并没有对inc值进行修改。然后虽然volatile能保证线程2对变量inc的值读取是从内存中读取的，但是线程1没有进行修改，所以线程2根本就不会看到修改的值。</p>
<p>根源就在这里，自增操作不是原子性操作，而且volatile也无法保证对变量的任何操作都是原子性的。</p>
<p>把上面的代码改成以下任何一种都可以达到效果：</p>
<p>采用synchronized：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span>  <span class="keyword">int</span> inc = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span> </span>&#123;</div><div class="line">        inc++;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Test test = <span class="keyword">new</span> Test();</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</div><div class="line">            <span class="keyword">new</span> Thread()&#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">1000</span>;j++)</div><div class="line">                        test.increase();</div><div class="line">                &#125;;</div><div class="line">            &#125;.start();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">while</span>(Thread.activeCount()&gt;<span class="number">1</span>)  <span class="comment">//保证前面的线程都执行完</span></div><div class="line">            Thread.yield();</div><div class="line">        System.out.println(test.inc);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>采用Lock：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span>  <span class="keyword">int</span> inc = <span class="number">0</span>;</div><div class="line">    Lock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span> </span>&#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            inc++;</div><div class="line">        &#125; <span class="keyword">finally</span>&#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Test test = <span class="keyword">new</span> Test();</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</div><div class="line">            <span class="keyword">new</span> Thread()&#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">1000</span>;j++)</div><div class="line">                        test.increase();</div><div class="line">                &#125;;</div><div class="line">            &#125;.start();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">while</span>(Thread.activeCount()&gt;<span class="number">1</span>)  <span class="comment">//保证前面的线程都执行完</span></div><div class="line">            Thread.yield();</div><div class="line">        System.out.println(test.inc);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>采用AtomicInteger：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span>  AtomicInteger inc = <span class="keyword">new</span> AtomicInteger();</div><div class="line">     </div><div class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span> </span>&#123;</div><div class="line">        inc.getAndIncrement();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Test test = <span class="keyword">new</span> Test();</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</div><div class="line">            <span class="keyword">new</span> Thread()&#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">1000</span>;j++)</div><div class="line">                        test.increase();</div><div class="line">                &#125;;</div><div class="line">            &#125;.start();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">while</span>(Thread.activeCount()&gt;<span class="number">1</span>)  <span class="comment">//保证前面的线程都执行完</span></div><div class="line">            Thread.yield();</div><div class="line">        System.out.println(test.inc);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在java 1.5的java.util.concurrent.atomic包下提供了一些原子操作类，即对基本数据类型的 自增（加1操作），自减（减1操作）、以及加法操作（加一个数），减法操作（减一个数）进行了封装，保证这些操作是原子性操作。atomic是利用CAS来实现原子性操作的（Compare And Swap），CAS实际上是利用处理器提供的CMPXCHG指令实现的，而处理器执行CMPXCHG指令是一个原子性操作。</p>
<h2 id="7-3-volatile能保证有序性吗？"><a href="#7-3-volatile能保证有序性吗？" class="headerlink" title="7.3 volatile能保证有序性吗？"></a>7.3 volatile能保证有序性吗？</h2><p>在前面提到volatile关键字能禁止指令重排序，所以volatile能在一定程度上保证有序性。</p>
<p>volatile关键字禁止指令重排序有两层意思：</p>
<ul>
<li><p>当程序执行到volatile变量的读操作或者写操作时，在其前面的操作的更改肯定全部已经进行，且结果已经对后面的操作可见；在其后面的操作肯定还没有进行；</p>
</li>
<li><p>在进行指令优化时，不能将在对volatile变量访问的语句放在其后面执行，也不能把volatile变量后面的语句放到其前面执行。</p>
</li>
</ul>
<p>可能上面说的比较绕，举个简单的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//x、y为非volatile变量</span></div><div class="line"><span class="comment">//flag为volatile变量</span></div><div class="line"> </div><div class="line">x = <span class="number">2</span>;        <span class="comment">//语句1</span></div><div class="line">y = <span class="number">0</span>;        <span class="comment">//语句2</span></div><div class="line">flag = <span class="keyword">true</span>;  <span class="comment">//语句3</span></div><div class="line">x = <span class="number">4</span>;         <span class="comment">//语句4</span></div><div class="line">y = -<span class="number">1</span>;       <span class="comment">//语句5</span></div></pre></td></tr></table></figure>
<p>由于flag变量为volatile变量，那么在进行指令重排序的过程的时候，不会将语句3放到语句1、语句2前面，也不会讲语句3放到语句4、语句5后面。但是要注意语句1和语句2的顺序、语句4和语句5的顺序是不作任何保证的。</p>
<p>并且volatile关键字能保证，执行到语句3时，语句1和语句2必定是执行完毕了的，且语句1和语句2的执行结果对语句3、语句4、语句5是可见的。</p>
<p>那么我们回到前面举的一个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//线程1:</span></div><div class="line">context = loadContext();   <span class="comment">//语句1</span></div><div class="line">inited = <span class="keyword">true</span>;             <span class="comment">//语句2</span></div><div class="line"> </div><div class="line"><span class="comment">//线程2:</span></div><div class="line"><span class="keyword">while</span>(!inited )&#123;</div><div class="line">  sleep()</div><div class="line">&#125;</div><div class="line">doSomethingwithconfig(context);</div></pre></td></tr></table></figure>
<p>前面举这个例子的时候，提到有可能语句2会在语句1之前执行，那么久可能导致context还没被初始化，而线程2中就使用未初始化的context去进行操作，导致程序出错。</p>
<p>这里如果用volatile关键字对inited变量进行修饰，就不会出现这种问题了，因为当执行到语句2时，必定能保证context已经初始化完毕。</p>
<h2 id="7-4-volatile的原理和实现机制"><a href="#7-4-volatile的原理和实现机制" class="headerlink" title="7.4 volatile的原理和实现机制"></a>7.4 volatile的原理和实现机制</h2><p>前面讲述了源于volatile关键字的一些使用，下面我们来探讨一下volatile到底如何保证可见性和禁止指令重排序的。下面这段话摘自《深入理解Java虚拟机》：</p>
<blockquote>
<p>“观察加入volatile关键字和没有加入volatile关键字时所生成的汇编代码发现，加入volatile关键字时，会多出一个lock前缀指令”</p>
</blockquote>
<p>lock前缀指令实际上相当于一个内存屏障（也成内存栅栏），内存屏障会提供3个功能：</p>
<ul>
<li>它确保指令重排序时不会把其后面的指令排到内存屏障之前的位置，也不会把前面的指令排到内存屏障的后面；即在执行到内存屏障这句指令时，在它前面的操作已经全部完成；</li>
<li>它会强制将对缓存的修改操作立即写入主存；</li>
<li>如果是写操作，它会导致其他CPU中对应的缓存行无效。</li>
</ul>
<h2 id="7-5-使用volatile关键字的场景"><a href="#7-5-使用volatile关键字的场景" class="headerlink" title="7.5 使用volatile关键字的场景"></a>7.5 使用volatile关键字的场景</h2><p>synchronized关键字是防止多个线程同时执行一段代码，那么就会很影响程序执行效率，而volatile关键字在某些情况下性能要优于synchronized，但是要注意volatile关键字是无法替代synchronized关键字的，因为volatile关键字无法保证操作的原子性。通常来说，使用volatile必须具备以下2个条件：</p>
<ul>
<li>对变量的写操作不依赖于当前值</li>
<li>该变量没有包含在具有其他变量的不变式中</li>
</ul>
<p>实际上，这些条件表明，可以被写入 volatile 变量的这些有效值独立于任何程序的状态，包括变量的当前状态。</p>
<p>事实上，我的理解就是上面的2个条件需要保证操作是原子性操作，才能保证使用volatile关键字的程序在并发时能够正确执行。</p>
<p>下面列举几个Java中使用volatile的几个场景。</p>
<p>状态标记量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">volatile</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</div><div class="line"> </div><div class="line"><span class="keyword">while</span>(!flag)&#123;</div><div class="line">    doSomething();</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFlag</span><span class="params">()</span> </span>&#123;</div><div class="line">    flag = <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">volatile</span> <span class="keyword">boolean</span> inited = <span class="keyword">false</span>;</div><div class="line"><span class="comment">//线程1:</span></div><div class="line">context = loadContext();  </div><div class="line">inited = <span class="keyword">true</span>;            </div><div class="line"> </div><div class="line"><span class="comment">//线程2:</span></div><div class="line"><span class="keyword">while</span>(!inited )&#123;</div><div class="line">sleep()</div><div class="line">&#125;</div><div class="line">doSomethingwithconfig(context);</div></pre></td></tr></table></figure>
<p>double check</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singleton</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> Singleton instance = <span class="keyword">null</span>;</div><div class="line">     </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;</div><div class="line">         </div><div class="line">    &#125;</div><div class="line">     </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(instance==<span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;</div><div class="line">                <span class="keyword">if</span>(instance==<span class="keyword">null</span>)</div><div class="line">                    instance = <span class="keyword">new</span> Singleton();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 至于为何需要这么写请参考：</p>
<p><a href="http://blog.csdn.net/dl88250/article/details/5439024" target="_blank" rel="external">Java 中的双重检查（Double-Check）</a></p>
<p><a href="http://www.iteye.com/topic/652440" target="_blank" rel="external">单例模式与双重检测</a></p>
<h1 id="8-参考资料"><a href="#8-参考资料" class="headerlink" title="8. 参考资料"></a>8. 参考资料</h1><p>《Java编程思想》</p>
<p>《深入理解Java虚拟机》</p>
<p><a href="http://jiangzhengjun.iteye.com/blog/652532" target="_blank" rel="external">http://jiangzhengjun.iteye.com/blog/652532</a></p>
<p><a href="http://blog.sina.com.cn/s/blog_7bee8dd50101fu8n.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_7bee8dd50101fu8n.html</a></p>
<p><a href="http://ifeve.com/volatile/" target="_blank" rel="external">http://ifeve.com/volatile/</a></p>
<p><a href="http://blog.csdn.net/ccit0519/article/details/11241403" target="_blank" rel="external">http://blog.csdn.net/ccit0519/article/details/11241403</a></p>
<p><a href="http://blog.csdn.net/ns_code/article/details/17101369" target="_blank" rel="external">http://blog.csdn.net/ns_code/article/details/17101369</a></p>
<p><a href="http://www.cnblogs.com/kevinwu/archive/2012/05/02/2479464.html" target="_blank" rel="external">http://www.cnblogs.com/kevinwu/archive/2012/05/02/2479464.html</a></p>
<p><a href="http://www.cppblog.com/elva/archive/2011/01/21/139019.html" target="_blank" rel="external">http://www.cppblog.com/elva/archive/2011/01/21/139019.html</a></p>
<p><a href="http://ifeve.com/volatile-array-visiblity/" target="_blank" rel="external">http://ifeve.com/volatile-array-visiblity/</a></p>
<p><a href="http://www.bdqn.cn/news/201312/12579.shtml" target="_blank" rel="external">http://www.bdqn.cn/news/201312/12579.shtml</a></p>
<p><a href="http://exploer.blog.51cto.com/7123589/1193399" target="_blank" rel="external">http://exploer.blog.51cto.com/7123589/1193399</a></p>
<p><a href="http://www.cnblogs.com/Mainz/p/3556430.html" target="_blank" rel="external">http://www.cnblogs.com/Mainz/p/3556430.html</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/30/泛型/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="JackChan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ai.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="秋过冬漫长">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/30/泛型/" itemprop="url">
                  泛型
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-30T23:55:59+08:00">
                2017-04-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/30/泛型/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/04/30/泛型/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-泛型概述"><a href="#1-泛型概述" class="headerlink" title="1. 泛型概述"></a>1. 泛型概述</h2><p>泛型（Generic type 或者 generics）是对 Java 语言的类型系统的一种扩展，以支持创建可以按类型进行参数化的类。可以把类型参数看作是使用参数化类型时指定的类型的一个占位符，就像方法的形式参数是运行时传递的值的占位符一样。</p>
<p>泛型是Java SE 1.5的新特性，泛型的本质是参数化类型，也就是说所操作的数据类型被指定为一个参数。这种参数类型可以用在类、接口和方法的创建中，分别称为泛型类、泛型接口、泛型方法。 Java语言引入泛型的好处是安全简单。</p>
<p>在Java SE 1.5之前，没有泛型的情况的下，通过对类型Object的引用来实现参数的“任意化”，“任意化”带来的缺点是要做显式的强制类型转换，而这种转换是要求开发者对实际参数类型可以预知的情况下进行的。对于强制类型转换错误的情况，编译器可能不提示错误，在运行的时候才出现异常，这是一个安全隐患。</p>
<p>泛型的好处是在编译的时候检查类型安全，并且所有的强制转换都是自动和隐式的，以提高代码的重用率。</p>
<p>可以在集合框架（Collection framework）中看到泛型的动机。例如，Map 类允许您向一个 Map添加任意类的对象，即使最常见的情况是在给定映射（map）中保存某个特定类型（比如 String）的对象。</p>
<p>因为 Map.get() 被定义为返回 Object，所以一般必须将 Map.get() 的结果强制类型转换为期望的类型，如下面的代码所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Map m = <span class="keyword">new</span> HashMap();</div><div class="line">m.put(<span class="string">"key"</span>, <span class="string">"blarg"</span>);</div><div class="line">String s = (String) m.get(<span class="string">"key"</span>);</div></pre></td></tr></table></figure>
<p>要让程序通过编译，必须将 get() 的结果强制类型转换为 String，并且希望结果真的是一个 String。但是有可能某人已经在该映射中保存了不是 String 的东西，这样的话，上面的代码将会抛出 ClassCastException。</p>
<p>理想情况下，您可能会得出这样一个观点，即 m 是一个 Map，它将 String 键映射到 String 值。这可以让您消除代码中的强制类型转换，同时获得一个附加的类型检查层，该检查层可以防止有人将错误类型的键或值保存在集合中。这就是泛型所做的工作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.itcast_01;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.Iterator;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * ArrayList存储字符串并遍历</div><div class="line"> * </div><div class="line"> * 我们按照正常的写法来写这个程序， 结果确出错了。</div><div class="line"> * 为什么呢?</div><div class="line"> * 		因为我们开始存储的时候，存储了String和Integer两种类型的数据。</div><div class="line"> * 		而在遍历的时候，我们把它们都当作String类型处理的，做了转换，所以就报错了。</div><div class="line"> * 但是呢，它在编译期间却没有告诉我们。</div><div class="line"> * 所以，我就觉得这个设计的不好。</div><div class="line"> * 回想一下，我们的数组</div><div class="line"> * 		String[] strArray = new String[3];</div><div class="line"> * 		strArray[0] = "hello";</div><div class="line"> * 		strArray[1] = "world";</div><div class="line"> * 		strArray[2] = 10;</div><div class="line"> * 集合也模仿着数组的这种做法，在创建对象的时候明确元素的数据类型。这样就不会在有问题了。</div><div class="line"> * 而这种技术被称为：泛型。</div><div class="line"> * </div><div class="line"> * 泛型：是一种把类型明确的工作推迟到创建对象或者调用方法的时候才去明确的特殊的类型。参数化类型，把类型当作参数一样的传递。</div><div class="line"> * 格式：</div><div class="line"> * 		&lt;数据类型&gt;</div><div class="line"> * 		此处的数据类型只能是引用类型。</div><div class="line"> * 好处：</div><div class="line"> * 		A:把运行时期的问题提前到了编译期间</div><div class="line"> * 		B:避免了强制类型转换</div><div class="line"> * 		C:优化了程序设计，解决了黄色警告线</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericDemo</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// 创建</span></div><div class="line">		ArrayList&lt;String&gt; array = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line"></div><div class="line">		<span class="comment">// 添加元素</span></div><div class="line">		array.add(<span class="string">"hello"</span>);</div><div class="line">		array.add(<span class="string">"world"</span>);</div><div class="line">		array.add(<span class="string">"java"</span>);</div><div class="line">		<span class="comment">// array.add(new Integer(100));</span></div><div class="line">		<span class="comment">//array.add(10); // JDK5以后的自动装箱</span></div><div class="line">		<span class="comment">// 等价于：array.add(Integer.valueOf(10));</span></div><div class="line"></div><div class="line">		<span class="comment">// 遍历</span></div><div class="line">		Iterator&lt;String&gt; it = array.iterator();</div><div class="line">		<span class="keyword">while</span> (it.hasNext()) &#123;</div><div class="line">			<span class="comment">// ClassCastException</span></div><div class="line">			<span class="comment">// String s = (String) it.next();</span></div><div class="line">			String s = it.next();</div><div class="line">			System.out.println(s);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// 看下面这个代码</span></div><div class="line">		<span class="comment">// String[] strArray = new String[3];</span></div><div class="line">		<span class="comment">// strArray[0] = "hello";</span></div><div class="line">		<span class="comment">// strArray[1] = "world";</span></div><div class="line">		<span class="comment">// strArray[2] = 10;</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-泛型的好处"><a href="#2-泛型的好处" class="headerlink" title="2. 泛型的好处"></a>2. 泛型的好处</h2><p>Java 语言中引入泛型是一个较大的功能增强。不仅语言、类型系统和编译器有了较大的变化，以支持泛型，而且类库也进行了大翻修，所以许多重要的类，比如集合框架，都已经成为泛型化的了。这带来了很多好处：</p>
<h3 id="2-1-类型安全"><a href="#2-1-类型安全" class="headerlink" title="2.1 类型安全"></a>2.1 类型安全</h3><p>泛型的主要目标是提高 Java 程序的类型安全。通过知道使用泛型定义的变量的类型限制，编译器可以在一个高得多的程度上验证类型假设。没有泛型，这些假设就只存在于程序员的头脑中（或者如果幸运的话，还存在于代码注释中）。</p>
<p>Java 程序中的一种流行技术是定义这样的集合，即它的元素或键是公共类型的，比如“String 列表”或者“String 到 String 的映射”。通过在变量声明中捕获这一附加的类型信息，泛型允许编译器实施这些附加的类型约束。类型错误现在就可以在编译时被捕获了，而不是在运行时当作 ClassCastException 展示出来。将类型检查从运行时挪到编译时有助于您更容易找到错误，并可提高程序的可靠性。</p>
<h3 id="2-2-消除强制类型转换"><a href="#2-2-消除强制类型转换" class="headerlink" title="2.2  消除强制类型转换"></a>2.2  消除强制类型转换</h3><p>泛型的一个附带好处是，消除源代码中的许多强制类型转换。这使得代码更加可读，并且减少了出错机会。<br>尽管减少强制类型转换可以降低使用泛型类的代码的罗嗦程度，但是声明泛型变量会带来相应的罗嗦。</p>
<h3 id="2-3-优化了程序设计，解决了黄色警告线"><a href="#2-3-优化了程序设计，解决了黄色警告线" class="headerlink" title="2.3 优化了程序设计，解决了黄色警告线"></a>2.3 优化了程序设计，解决了黄色警告线</h3><h2 id="3-泛型的应用"><a href="#3-泛型的应用" class="headerlink" title="3. 泛型的应用"></a>3. 泛型的应用</h2><h3 id="3-1-泛型的内部原理"><a href="#3-1-泛型的内部原理" class="headerlink" title="3.1 泛型的内部原理"></a>3.1 泛型的内部原理</h3><p>泛型是提供给javac编译器使用的，可以限定集合中的输入类型，让编译器挡住源程序中的非法输入。但是，编译器编译带类型说明的集合时会去除掉“类型”信息，目的就是使程序运行效率不受影响。因此，对于参数化的泛型类型，getClass()方法的返回值和原始类型完全一样。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.itheima.day2;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericTest</span> </span>&#123;</div><div class="line">      </div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">            ArrayList&lt;String&gt; collection1 = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">            ArrayList collection2 = <span class="keyword">new</span> ArrayList();</div><div class="line">            System. out.println(collection1.getClass() == collection2.getClass());</div><div class="line">             <span class="comment">//结果：true</span></div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于编译生成的字节码会去掉泛型的类型信息，只要能跳过编译器，就可以往某个泛型集合中加入其它类型的数据，例如，用反射得到集合，再调用其add方法即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.itheima.day2;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericTest</span> </span>&#123;</div><div class="line">      </div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            ArrayList&lt;Integer&gt; collection1 = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</div><div class="line">            collection1.getClass().getMethod( <span class="string">"add"</span>,Object.class).invoke(collection1, <span class="string">"abc"</span>);</div><div class="line">            System. out.println(collection1.get(<span class="number">0</span>));</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ArrayList<e>类定义和ArrayList<integer>类引用中涉及如下术语：</integer></e></p>
<ul>
<li>整个称为ArrayList&lt;E&gt;泛型类型</li>
<li>ArrayList&lt;E&gt;中的E称为类型变量或类型参数</li>
<li>整个ArrayList&lt;Integer&gt;称为参数化的类型</li>
<li>ArrayList&lt;Integer&gt;中的Integer称为类型参数的实例或实际类型参数</li>
<li>ArrayList&lt;Integer&gt;中的&lt;&gt;念着typeof</li>
<li>ArrayList称为原始类型</li>
</ul>
<p>参数化类型与原始类型的兼容性：参数化类型可以引用一个原始类型的对象，编译报告警告，例如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Collection&lt;String&gt; c = <span class="keyword">new</span> Vector();<span class="comment">//考虑到对以前代码的兼容性，编译器是可以通过的</span></div></pre></td></tr></table></figure>
<p>原始类型可以引用一个参数化类型的对象，编译报告警告，例如<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Collection c = <span class="keyword">new</span> Vector&lt;String&gt;();<span class="comment">//原来的方法接受一个集合参数，新的类型也要能传进去</span></div></pre></td></tr></table></figure></p>
<p>参数化类型不考虑类型参数的继承关系：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Vector&lt;String&gt; v = <span class="keyword">new</span> Vector&lt;Object&gt;(); <span class="comment">//错误!不写&lt;Object&gt;没错，写了就是明知故犯</span></div><div class="line">Vector&lt;Object&gt; v = <span class="keyword">new</span> Vector&lt;String&gt;(); <span class="comment">//也错误!</span></div></pre></td></tr></table></figure>
<p>注意： </p>
<p>假设Vector&lt;String&gt; v = new Vector&lt;Object&gt;();可以的话，那么以后从v中取出的对象当作String用，而v实际指向的对象中可以加入任意的类型对象；</p>
<p>假设Vector&lt;Object&gt; v = new Vector&lt;String&gt;();可以的话，那么以后可以向v中加入任意的类型对象，而v实际指向的集合中只能装String类型的对象。</p>
<p>编译器不允许创建泛型变量的数组。即在创建数组实例时，数组的元素不能使用参数化的类型。</p>
<p>例如，下面语句有错误：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Vector&lt;Integer&gt; vectorList[] = <span class="keyword">new</span> Vector&lt;Integer&gt;[<span class="number">10</span>];</div></pre></td></tr></table></figure>
<p>思考题：</p>
<p>下面的代码会报错误吗？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Vector v1 = <span class="keyword">new</span> Vector&lt;String&gt;();</div><div class="line">Vector&lt;Object&gt; v = v1;</div></pre></td></tr></table></figure>
<p>答案：编译的时候是不会报错的，因为编译器是一行一行按照语法检查代码的，因此不会出错。</p>
<h2 id="4-泛型类"><a href="#4-泛型类" class="headerlink" title="4. 泛型类"></a>4. 泛型类</h2><p>把泛型定义在类上，格式:public class 类名&lt;泛型类型1,…&gt;，注意:泛型类型必须是引用类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.itcast_04;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * 泛型类的测试</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectToolDemo</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// ObjectTool ot = new ObjectTool();</span></div><div class="line">		<span class="comment">//</span></div><div class="line">		<span class="comment">// ot.setObj(new String("风清扬"));</span></div><div class="line">		<span class="comment">// String s = (String) ot.getObj();</span></div><div class="line">		<span class="comment">// System.out.println("姓名是：" + s);</span></div><div class="line">		<span class="comment">//</span></div><div class="line">		<span class="comment">// ot.setObj(new Integer(30));</span></div><div class="line">		<span class="comment">// Integer i = (Integer) ot.getObj();</span></div><div class="line">		<span class="comment">// System.out.println("年龄是：" + i);</span></div><div class="line"></div><div class="line">		<span class="comment">// ot.setObj(new String("林青霞"));</span></div><div class="line">		<span class="comment">// // ClassCastException</span></div><div class="line">		<span class="comment">// Integer ii = (Integer) ot.getObj();</span></div><div class="line">		<span class="comment">// System.out.println("姓名是：" + ii);</span></div><div class="line"></div><div class="line">		System.out.println(<span class="string">"-------------"</span>);</div><div class="line"></div><div class="line">		ObjectTool&lt;String&gt; ot = <span class="keyword">new</span> ObjectTool&lt;String&gt;();</div><div class="line">		<span class="comment">// ot.setObj(new Integer(27)); //这个时候编译期间就过不去</span></div><div class="line">		ot.setObj(<span class="keyword">new</span> String(<span class="string">"林青霞"</span>));</div><div class="line">		String s = ot.getObj();</div><div class="line">		System.out.println(<span class="string">"姓名是："</span> + s);</div><div class="line"></div><div class="line">		ObjectTool&lt;Integer&gt; ot2 = <span class="keyword">new</span> ObjectTool&lt;Integer&gt;();</div><div class="line">		<span class="comment">// ot2.setObj(new String("风清扬"));//这个时候编译期间就过不去</span></div><div class="line">		ot2.setObj(<span class="keyword">new</span> Integer(<span class="number">27</span>));</div><div class="line">		Integer i = ot2.getObj();</div><div class="line">		System.out.println(<span class="string">"年龄是："</span> + i);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//泛型类：把泛型定义在类上</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectTool</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">	<span class="keyword">private</span> T obj;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">getObj</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> obj;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setObj</span><span class="params">(T obj)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.obj = obj;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="5-泛型方法"><a href="#5-泛型方法" class="headerlink" title="5. 泛型方法"></a>5. 泛型方法</h2><p>把泛型定义在方法上，格式:public &lt;泛型类型&gt; 返回类型 方法名(泛型类型 .)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.itcast_05;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectToolDemo</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// ObjectTool ot = new ObjectTool();</span></div><div class="line">		<span class="comment">// ot.show("hello");</span></div><div class="line">		<span class="comment">// ot.show(100);</span></div><div class="line">		<span class="comment">// ot.show(true);</span></div><div class="line"></div><div class="line">		<span class="comment">// ObjectTool&lt;String&gt; ot = new ObjectTool&lt;String&gt;();</span></div><div class="line">		<span class="comment">// ot.show("hello");</span></div><div class="line">		<span class="comment">//</span></div><div class="line">		<span class="comment">// ObjectTool&lt;Integer&gt; ot2 = new ObjectTool&lt;Integer&gt;();</span></div><div class="line">		<span class="comment">// ot2.show(100);</span></div><div class="line">		<span class="comment">//</span></div><div class="line">		<span class="comment">// ObjectTool&lt;Boolean&gt; ot3 = new ObjectTool&lt;Boolean&gt;();</span></div><div class="line">		<span class="comment">// ot3.show(true);</span></div><div class="line"></div><div class="line">		<span class="comment">// 定义泛型方法后</span></div><div class="line">		ObjectTool ot = <span class="keyword">new</span> ObjectTool();</div><div class="line">		ot.show(<span class="string">"hello"</span>);</div><div class="line">		ot.show(<span class="number">100</span>);</div><div class="line">		ot.show(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//泛型方法：把泛型定义在方法上</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectTool</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(T t)</span> </span>&#123;</div><div class="line">		System.out.println(t);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="6-泛型接口"><a href="#6-泛型接口" class="headerlink" title="6. 泛型接口"></a>6. 泛型接口</h2><p>把泛型定义在接口上，格式:public  interface 接口名&lt;泛型类型1…&gt;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.itcast_06;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterDemo</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// 第一种情况的测试</span></div><div class="line">		<span class="comment">// Inter&lt;String&gt; i = new InterImpl();</span></div><div class="line">		<span class="comment">// i.show("hello");</span></div><div class="line"></div><div class="line">		<span class="comment">// // 第二种情况的测试</span></div><div class="line">		Inter&lt;String&gt; i = <span class="keyword">new</span> InterImpl&lt;String&gt;();</div><div class="line">		i.show(<span class="string">"hello"</span>);</div><div class="line"></div><div class="line">		Inter&lt;Integer&gt; ii = <span class="keyword">new</span> InterImpl&lt;Integer&gt;();</div><div class="line">		ii.show(<span class="number">100</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//泛型接口：把泛型定义在接口上 </span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Inter</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(T t)</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 实现类在实现接口的时候</span></div><div class="line"><span class="comment">// 第一种情况：已经知道该是什么类型的了</span></div><div class="line"></div><div class="line"><span class="comment">//public class InterImpl implements Inter&lt;String&gt; &#123;</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//	@Override</span></div><div class="line"><span class="comment">//	public void show(String t) &#123;</span></div><div class="line"><span class="comment">//		System.out.println(t);</span></div><div class="line"><span class="comment">//	&#125;</span></div><div class="line"><span class="comment">// &#125;</span></div><div class="line"></div><div class="line"><span class="comment">// 第二种情况：还不知道是什么类型的</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InterImpl</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Inter</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(T t)</span> </span>&#123;</div><div class="line">		System.out.println(t);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="7-泛型高级-通配符"><a href="#7-泛型高级-通配符" class="headerlink" title="7. 泛型高级(通配符)"></a>7. 泛型高级(通配符)</h2><p>为了解决类型被限制死了不能动态根据实例来确定的缺点，引入了“通配符泛型”，针对上面的例子，使用通配泛型格式为&lt;? extends Collection&gt;，“？”代表未知类型，这个类型是实现Collection接口。? extends E：向下限定，E及其子类，限定通配符的上边界。? super E：向上限定，E及其父类，限定通配符的下边界。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.itcast_07;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.Collection;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * 泛型高级(通配符)</div><div class="line"> * ?:任意类型，如果没有明确，那么就是Object以及任意的Java类了</div><div class="line"> * ? extends E:向下限定，E及其子类</div><div class="line"> * ? super E:向上限定，E极其父类</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericDemo</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// 泛型如果明确的写的时候，前后必须一致</span></div><div class="line">		Collection&lt;Object&gt; c1 = <span class="keyword">new</span> ArrayList&lt;Object&gt;();</div><div class="line">		<span class="comment">// Collection&lt;Object&gt; c2 = new ArrayList&lt;Animal&gt;();</span></div><div class="line">		<span class="comment">// Collection&lt;Object&gt; c3 = new ArrayList&lt;Dog&gt;();</span></div><div class="line">		<span class="comment">// Collection&lt;Object&gt; c4 = new ArrayList&lt;Cat&gt;();</span></div><div class="line"></div><div class="line">		<span class="comment">// ?表示任意的类型都是可以的</span></div><div class="line">		Collection&lt;?&gt; c5 = <span class="keyword">new</span> ArrayList&lt;Object&gt;();</div><div class="line">		Collection&lt;?&gt; c6 = <span class="keyword">new</span> ArrayList&lt;Animal&gt;();</div><div class="line">		Collection&lt;?&gt; c7 = <span class="keyword">new</span> ArrayList&lt;Dog&gt;();</div><div class="line">		Collection&lt;?&gt; c8 = <span class="keyword">new</span> ArrayList&lt;Cat&gt;();</div><div class="line"></div><div class="line">		<span class="comment">// ? extends E:向下限定，E及其子类</span></div><div class="line">		<span class="comment">// Collection&lt;? extends Animal&gt; c9 = new ArrayList&lt;Object&gt;();</span></div><div class="line">		Collection&lt;? extends Animal&gt; c10 = <span class="keyword">new</span> ArrayList&lt;Animal&gt;();</div><div class="line">		Collection&lt;? extends Animal&gt; c11 = <span class="keyword">new</span> ArrayList&lt;Dog&gt;();</div><div class="line">		Collection&lt;? extends Animal&gt; c12 = <span class="keyword">new</span> ArrayList&lt;Cat&gt;();</div><div class="line"></div><div class="line">		<span class="comment">// ? super E:向上限定，E极其父类</span></div><div class="line">		Collection&lt;? <span class="keyword">super</span> Animal&gt; c13 = <span class="keyword">new</span> ArrayList&lt;Object&gt;();</div><div class="line">		Collection&lt;? <span class="keyword">super</span> Animal&gt; c14 = <span class="keyword">new</span> ArrayList&lt;Animal&gt;();</div><div class="line">		<span class="comment">// Collection&lt;? super Animal&gt; c15 = new ArrayList&lt;Dog&gt;();</span></div><div class="line">		<span class="comment">// Collection&lt;? super Animal&gt; c16 = new ArrayList&lt;Cat&gt;();</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">extends</span> <span class="title">Animal</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">extends</span> <span class="title">Animal</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h2><p>泛型是提供给javac编译器使用的，可以限定集合中的输入类型，让编译器挡住源程序中的非法输入，编译器编译带类型说明的集合时会去除掉“类型”信息，使程序运行效率不受影响，对于参数化的泛型类型，getClass()方法的返回值和原始类型完全一样。由于编译生成的字节码会去掉泛型的类型信息，只要能跳过编译器，就可以往某个泛型集合中加入其它类型的数据，例如，用反射得到集合，再调用其add方法即可。</p>
<p>泛型引用和创建两端，给出的泛型变量必须相同</p>
<h2 id="泛型类"><a href="#泛型类" class="headerlink" title="泛型类"></a>泛型类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">A&lt;T&gt;</div><div class="line">Class&lt;T&gt; type</div></pre></td></tr></table></figure>
<p>泛型类中使用泛型</p>
<ul>
<li>成员类型</li>
<li>返回值和参数类型</li>
<li>局部变量的引用上</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> T bean;<span class="comment">//泛型可在成员变量上使用</span></div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">fun</span><span class="params">(T t)</span> </span>&#123;&#125;<span class="comment">//泛型可以在类中的方法上（返回值和参数类型）使用！</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fun2</span><span class="params">()</span> </span>&#123;<span class="comment">//泛型还可以在局部变量的引用类型上使用</span></div><div class="line">        T b = ...</div><div class="line">        <span class="keyword">new</span> T();<span class="comment">//不行的！</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="泛型方法"><a href="#泛型方法" class="headerlink" title="泛型方法"></a>泛型方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">add</span><span class="params">(T x, T y)</span></span>&#123; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>泛型方法与泛型类没有什么关系，泛型方法不一定非要在泛型类中！</p>
<h2 id="泛型的继承和实现"><a href="#泛型的继承和实现" class="headerlink" title="泛型的继承和实现"></a>泛型的继承和实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AA不是泛型类，只是它爸爸是泛型类！</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AA</span> <span class="keyword">extends</span> <span class="title">A</span>&lt;<span class="title">String</span>&gt; </span>&#123;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>继承泛型类</p>
<ul>
<li>子类不是泛型类：需要给父类传递类型常量</li>
</ul>
<p>当给父类传递的类型常量为String时，那么在父类中所有T都会被String替换！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AA1</span> <span class="keyword">extends</span> <span class="title">A</span>&lt;<span class="title">String</span>&gt; </span>&#123;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>子类是泛型类：可以给父类传递类型常量，也可以传递类型变量</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AA3</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">A</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="通配符"><a href="#通配符" class="headerlink" title="通配符"></a>通配符</h2><ul>
<li>无限通配符&lt;?&gt;</li>
<li>向下通配符&lt;? extends T&gt;</li>
<li>向上通配符&lt;? super T&gt;</li>
</ul>
<h2 id="类型推断"><a href="#类型推断" class="headerlink" title="类型推断"></a>类型推断</h2><ul>
<li>通过反射的方式获取泛型的实际类型</li>
<li>泛型只能是引用类型，不能是基本数据类型</li>
</ul>
<h2 id="泛型擦除"><a href="#泛型擦除" class="headerlink" title="泛型擦除"></a>泛型擦除</h2><p>泛型会在编译时擦除，List<string>和List<user>这两个的字节码文件那一个都是List.class</user></string></p>
<h2 id="Gson泛型封装"><a href="#Gson泛型封装" class="headerlink" title="Gson泛型封装"></a>Gson泛型封装</h2><p>在<a href="http://www.jianshu.com/p/e740196225a4" target="_blank" rel="external">你真的会用Gson吗?Gson使用指南（一）</a> 的第三节我介绍了在Gson中如何使用泛型来简化我们的类设计，但随之而来引入了一个新的问题：封装。不知道各位有没有想过这样一个问题：每次都要用 <code>new TypeToken&lt;XXX&gt;(){};</code> 好麻烦，有没有更好的办法?</p>
<p>有更好的办法么?当然有！相信也有不少人自己作了尝试，只是有人欢喜有人愁了，不过没关系，今天我们就来解决这个问题。</p>
<h3 id="约定"><a href="#约定" class="headerlink" title="约定"></a>约定</h3><p>1、本文涉及到的json格式</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// data 为 object 的情况</div><div class="line">&#123;"code":"0","message":"success","data":&#123;&#125;&#125;</div><div class="line">// data 为 array 的情况</div><div class="line">&#123;"code":"0","message":"success","data":[]&#125;</div></pre></td></tr></table></figure>
<p>2、假定第一种的对应的Java类型为 <code>Result&lt;XXX&gt;</code> ，第二种为 <code>Result&lt;List&lt;XXX&gt;&gt;</code></p>
<h3 id="为何封装，如何封装"><a href="#为何封装，如何封装" class="headerlink" title="为何封装，如何封装"></a>为何封装，如何封装</h3><h4 id="1-为何封装："><a href="#1-为何封装：" class="headerlink" title="1. 为何封装："></a>1. 为何封装：</h4><ul>
<li>写<code>new TypeToken&lt;XXX&gt;(){}</code> 麻烦，IDE格式化后还不好看</li>
<li>不同的地方每进行一次 <code>new TypeToken&lt;XXX&gt;(){}</code> 操作都会生成一个新的类</li>
<li>对于任意类<code>XXX</code>都只有两种情况<code>new TypeToken&lt;Result&lt;XXX&gt;&gt;(){}</code>和<code>new TypeToken&lt;Result&lt;List&lt;XXX&gt;&gt;&gt;(){}</code></li>
<li>方便统一管理</li>
</ul>
<h4 id="2-如何封装"><a href="#2-如何封装" class="headerlink" title="2. 如何封装"></a>2. 如何封装</h4><p>从上面的我们可以知道，最简单的方法就是提供两个方法分别对应<code>data</code>为Array和Object的情况并接收一个参数，即告知XXX的类型，自动将完成<code>new TypeToken&lt;XXX&gt;(){}</code>与<code>new TypeToken&lt;Result&lt;List&lt;XXX&gt;&gt;&gt;(){}</code>的过程。</p>
<p><strong>方法原型：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 处理 data 为 object 的情况</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Result&lt;T&gt; <span class="title">fromJsonObject</span><span class="params">(Reader reader, Class&lt;T&gt; clazz)</span> </span>&#123;&#125;</div><div class="line"><span class="comment">// 处理 data 为 array 的情况</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;List&lt;T&gt;&gt; fromJsonArray(Reader reader, Class&lt;T&gt; clazz)&#123;&#125;</div></pre></td></tr></table></figure>
<h3 id="为何失败"><a href="#为何失败" class="headerlink" title="为何失败?"></a>为何失败?</h3><p>对于那些尝试着封装过的人可能都这么写过：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;List&lt;T&gt;&gt; fromJsonArray(Reader reader) &#123;</div><div class="line">    Type type = <span class="keyword">new</span> TypeToken&lt;Result&lt;List&lt;T&gt;&gt;&gt;()&#123;&#125;.getType();</div><div class="line">    <span class="keyword">return</span> GSON.fromJson(reader, type);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然上面的写法肯定是没有办法完成的，虽然代码不会报错，但运行结果肯定是不对的，因为这里的<code>T</code> 其实是一个 <code>TypeVariable</code>，他在运行时并不会变成我们想要的XXX，所以通过<code>TypeToken</code> 得到的 泛型信息只是 <code>&quot;Result&lt;List&lt;T&gt;&gt;&quot;</code>。</p>
<h3 id="如何解决"><a href="#如何解决" class="headerlink" title="如何解决?"></a>如何解决?</h3><p>既然TypeToken的作用是用于获取泛型的类，返回的类型为<code>Type</code>，真正的泛型信息就是放在这个<code>Type</code>里面，既然用TypeToken生成会有问题,那我们自己生成Type就行了嘛。</p>
<p>Type是Java中所有类型的父接口，在1.8以前是一个空接口，自1.8起多了个<code>getTypeName()</code>方法，下面有<code>ParameterizedType</code>、 <code>GenericArrayType</code>、 <code>WildcardType</code>、 <code>TypeVariable</code> 几个接口，以及<code>Class</code>类。这几个接口在本次封装过程中只会用到 <code>ParameterizedType</code> ，所以简单说一下：</p>
<p><code>ParameterizedType</code> 简单说来就是形如“ <strong>类型&lt;&gt;</strong> ”的类型，如:<code>Map&lt;String,User&gt;</code>。下面就以 <code>Map&lt;String,User&gt;</code> 为例讲一下里面各个方法的作用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ParameterizedType</span> <span class="keyword">extends</span> <span class="title">Type</span> </span>&#123;</div><div class="line">     <span class="comment">// 返回Map&lt;String,User&gt;里的String和User，所以这里返回[String.class,User.clas]</span></div><div class="line">    Type[] getActualTypeArguments(); </div><div class="line">    <span class="comment">// Map&lt;String,User&gt;里的Map,所以返回值是Map.class</span></div><div class="line">    <span class="function">Type <span class="title">getRawType</span><span class="params">()</span></span>;</div><div class="line">    <span class="comment">// 用于这个泛型上中包含了内部类的情况,一般返回null</span></div><div class="line">    <span class="function">Type <span class="title">getOwnerType</span><span class="params">()</span></span>; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以，知道了这里需要的泛型是怎么回事，一切都好说了，下面我们来完成之前留下的空方法。</p>
<h4 id="1-实现一个简易的-ParameterizedType"><a href="#1-实现一个简易的-ParameterizedType" class="headerlink" title="1. 实现一个简易的 ParameterizedType"></a>1. 实现一个简易的 ParameterizedType</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParameterizedTypeImpl</span> <span class="keyword">implements</span> <span class="title">ParameterizedType</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class raw;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Type[] args;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ParameterizedTypeImpl</span><span class="params">(Class raw, Type[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.raw = raw;</div><div class="line">        <span class="keyword">this</span>.args = args != <span class="keyword">null</span> ? args : <span class="keyword">new</span> Type[<span class="number">0</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Type[] getActualTypeArguments() &#123;</div><div class="line">        <span class="keyword">return</span> args;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Type <span class="title">getRawType</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> raw;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Type <span class="title">getOwnerType</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-生成Gson需要的泛型"><a href="#2-生成Gson需要的泛型" class="headerlink" title="2. 生成Gson需要的泛型"></a>2. 生成Gson需要的泛型</h4><h5 id="2-1-解析data是object的情况"><a href="#2-1-解析data是object的情况" class="headerlink" title="2.1 解析data是object的情况"></a>2.1 解析data是object的情况</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Result&lt;T&gt; <span class="title">fromJsonObject</span><span class="params">(Reader reader, Class&lt;T&gt; clazz)</span> </span>&#123;</div><div class="line">    Type type = <span class="keyword">new</span> ParameterizedTypeImpl(Result.class, <span class="keyword">new</span> Class[]&#123;clazz&#125;);</div><div class="line">    <span class="keyword">return</span> GSON.fromJson(reader, type);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="2-2-解析data是array的情况"><a href="#2-2-解析data是array的情况" class="headerlink" title="2.2 解析data是array的情况"></a>2.2 解析data是array的情况</h5><p>是Array的情况要比是Object的情况多那么一步。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;List&lt;T&gt;&gt; fromJsonArray(Reader reader, Class&lt;T&gt; clazz) &#123;</div><div class="line">    <span class="comment">// 生成List&lt;T&gt; 中的 List&lt;T&gt;</span></div><div class="line">    Type listType = <span class="keyword">new</span> ParameterizedTypeImpl(List.class, <span class="keyword">new</span> Class[]&#123;clazz&#125;);</div><div class="line">    <span class="comment">// 根据List&lt;T&gt;生成完整的Result&lt;List&lt;T&gt;&gt;</span></div><div class="line">    Type type = <span class="keyword">new</span> ParameterizedTypeImpl(Result.class, <span class="keyword">new</span> Type[]&#123;listType&#125;);</div><div class="line">    <span class="keyword">return</span> GSON.fromJson(reader, type);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>本次代码较少，不提供源码</strong></p>
<p><strong>虽然这篇博客是以Gson为例，但从上面的内容可以看出实际上和Gson关系不大，主要的内容还是Java的泛型基础，所以这种封装的方法同样适用于其它的框架。</strong></p>
<p>最后借这次机会给安利一个简易的泛型生成库 <strong>TypeBuilder</strong> ，其最初实现的目的就是让大家快速的生成泛型信息，同时也会作一些参数检查，保证正确性。</p>
<p>用上面的代码给大家举个例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;List&lt;T&gt;&gt; fromJsonArray(Reader reader, Class&lt;T&gt; clazz) &#123;</div><div class="line">    Type type = TypeBuilder</div><div class="line">            .newInstance(Result.class)</div><div class="line">            .beginSubType(List.class)</div><div class="line">            .addTypeParam(clazz)</div><div class="line">            .endSubType()</div><div class="line">            .build();</div><div class="line">    <span class="keyword">return</span> GSON.fromJson(reader, type);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Result&lt;T&gt; <span class="title">fromJsonObject</span><span class="params">(Reader reader, Class&lt;T&gt; clazz)</span> </span>&#123;</div><div class="line">    Type type = TypeBuilder</div><div class="line">            .newInstance(Result.class)</div><div class="line">            .addTypeParam(clazz)</div><div class="line">            .build();</div><div class="line">    <span class="keyword">return</span> GSON.fromJson(reader, type);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h2><p>Type 是 Java 编程语言中所有类型的公共高级接口。它们包括原始类型、参数化类型、数组类型、类型变量和基本类型</p>
<h3 id="ParameterizedType"><a href="#ParameterizedType" class="headerlink" title="ParameterizedType"></a>ParameterizedType</h3><p>ParameterizedType 表示参数化类型，如 Collection<string></string></p>
<table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Type[ ]  getActualTypeArguments()</td>
<td style="text-align:left">获取真实参数</td>
</tr>
</tbody>
</table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseProtocol</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 泛型解析</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> T <span class="title">parsejson</span><span class="params">(String jsonString)</span></span>&#123;</div><div class="line">        ParameterizedType genericSuperclass = (ParameterizedType) getClass().getGenericSuperclass();</div><div class="line">        Type[] args = genericSuperclass.getActualTypeArguments();</div><div class="line">        Type type = args[<span class="number">0</span>];</div><div class="line">        <span class="keyword">return</span> GsonUtil.changeGsonToBean(jsonString,type);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/30/注解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="JackChan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/ai.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="秋过冬漫长">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/30/注解/" itemprop="url">
                  注解
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-30T23:55:45+08:00">
                2017-04-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/30/注解/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/04/30/注解/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#<strong>系列阅读</strong></p>
<ul>
<li><a href="http://blog.csdn.net/axi295309066/article/details/52893604" target="_blank" rel="external">Java基础：类加载器</a></li>
<li><a href="http://blog.csdn.net/axi295309066/article/details/52888711" target="_blank" rel="external">Java基础：反射</a></li>
<li><a href="http://blog.csdn.net/axi295309066/article/details/52893032" target="_blank" rel="external">Java基础：注解</a></li>
<li><a href="http://blog.csdn.net/axi295309066/article/details/52892859" target="_blank" rel="external">Java基础：动态代理</a></li>
</ul>
<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>注解相当于一种标记，在程序中加了注解就等于为程序打上了某种标记，没加，则等于没有某种标记，以后，javac编译器，开发工具和其他程序可以用反射来了解你的类及各种元素上有无何种标记，看你有什么标记，就去干相应的事。标记可以加在包，类，字段，方法，方法的参数以及局部变量上</p>
<p>开发中常见注解：</p>
<ul>
<li>@Override：作用在方法上的注解。当方法不是重写父类的方法时会报错</li>
<li>@Deprecated：作用在方法上。标记该方法为作废方法（已过时）</li>
<li>@SuppressWarnings：作用在方法上，压制警告</li>
</ul>
<p>应用</p>
<ul>
<li>标记一些信息</li>
<li>运行时动态处理</li>
<li>编译时动态处理</li>
</ul>
<h1 id="2-注解类型"><a href="#2-注解类型" class="headerlink" title="2. 注解类型"></a>2. 注解类型</h1><p>8种基本数据类型，String，Class，enum，annotation，以上类型的数组类型</p>
<h1 id="3-定义注解"><a href="#3-定义注解" class="headerlink" title="3. 定义注解"></a>3. 定义注解</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.FIELD)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ViewInject &#123;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">value</span><span class="params">()</span></span>;<span class="comment">//当使用注解时，如果只给名为value的属性赋值时，可以省略“value=”</span></div><div class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> "zhangsan"</span>;<span class="comment">//默认值</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="interface"><a href="#interface" class="headerlink" title="@interface"></a>@interface</h3><p>使用@interface声明一个注解类</p>
<h3 id="Target"><a href="#Target" class="headerlink" title="@Target"></a>@Target</h3><p>表示注解的作用目标，是一个枚举值</p>
<table>
<thead>
<tr>
<th style="text-align:left">作用目标</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ElementType.FIELD</td>
<td style="text-align:left">作用于成员变量</td>
</tr>
<tr>
<td style="text-align:left">ElementType.METHOD</td>
<td style="text-align:left">作用于方法</td>
</tr>
<tr>
<td style="text-align:left">ElementType.CONSTRUCTOR</td>
<td style="text-align:left">作用于构造方法</td>
</tr>
<tr>
<td style="text-align:left">ElementType.PARAMETER</td>
<td style="text-align:left">作用于方法的参数</td>
</tr>
<tr>
<td style="text-align:left">ElementType.TYPE</td>
<td style="text-align:left">作用于类，接口，enum， Annotation</td>
</tr>
</tbody>
</table>
<h3 id="Retention"><a href="#Retention" class="headerlink" title="@Retention"></a>@Retention</h3><p>表示注解的保存策略，也是一个枚举值</p>
<p>注解的保留策略是指，注解是只保留在源代码上，还是保留到class文件上，再或者是类在运行时，可以被类加载器加载到内存中。</p>
<p>如果希望注解被反射，那么注解就要保留到运行时，而不是源代码或类文件上。</p>
<p>指定注解的保留策略需要使用元注解@Retention，它有一个value属性，类型为RetentionPolicy类型，RetentionPolicy是枚举类型</p>
<table>
<thead>
<tr>
<th style="text-align:left">保存策略</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">RetentionPolicy.SOURCE</td>
<td style="text-align:left">注解只保存在源代码中，即.java文件</td>
</tr>
<tr>
<td style="text-align:left">RetentionPolicy.CLASS</td>
<td style="text-align:left">注解保存在字节码中,即.class文件</td>
</tr>
<tr>
<td style="text-align:left">RetentionPolicy.RUNTIME</td>
<td style="text-align:left">注解保存在内存中的字节码，可用于反射</td>
</tr>
</tbody>
</table>
<h3 id="注解的属性"><a href="#注解的属性" class="headerlink" title="注解的属性"></a>注解的属性</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> "zhangsan"</span>;<span class="comment">//默认值</span></div></pre></td></tr></table></figure>
<p>定义注解的属性，有点像java类中的方法，上面的代码定义了一个类型为String类型，注解名为name的属性，default是给注解设置默认值</p>
<h3 id="value属性"><a href="#value属性" class="headerlink" title="value属性"></a>value属性</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> "xxx"</span>;</div></pre></td></tr></table></figure>
<p>如果注解中有一个名称为value的属性，且你只想设置value属性（即其他属性都采用默认值或者你只有一个value属性），那么可以省略value=部分，例如：@MyAnnotation(“AllenIverson”)</p>
<h3 id="数组类型的属性"><a href="#数组类型的属性" class="headerlink" title="数组类型的属性"></a>数组类型的属性</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> [] arrayAttr() <span class="keyword">default</span> &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;<span class="comment">//定义</span></div><div class="line"><span class="meta">@MyAnnotation</span>(arrayAttr=&#123;<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;)<span class="comment">//使用</span></div></pre></td></tr></table></figure>
<p>如果数组属性中只有一个元素，这时候属性值部分可以省略大括</p>
<h1 id="4-Annotation"><a href="#4-Annotation" class="headerlink" title="4. Annotation"></a>4. Annotation</h1><h2 id="4-1-注解的应用结构图"><a href="#4-1-注解的应用结构图" class="headerlink" title="4.1 注解的应用结构图"></a>4.1 注解的应用结构图</h2><p><img src="http://img.blog.csdn.net/20161022152925252" alt="Annotation"></p>
<p>Annotation</p>
<table>
<thead>
<tr>
<th style="text-align:left">方法声明</th>
<th style="text-align:left">功能描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">annotationType()</td>
<td style="text-align:left">获取注解类型</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h2 id="4-2-反射注解"><a href="#4-2-反射注解" class="headerlink" title="4.2 反射注解"></a>4.2 反射注解</h2><p>类上的注解：使用Class获取</p>
<ul>
<li>Class.getAnnotation()：获取指定类型的注解</li>
<li>Class.getAnnotations()：获取所有的注解</li>
<li>Class.getDeclaredAnnotations()：获取除了继承得到的所有注解</li>
</ul>
<p>方法上的注解：使用Method获取</p>
<ul>
<li>Method.getAnnotation() ：获取方法上指定类型的注解</li>
<li>Method.getAnnotations()：获取所有的注解</li>
<li>Method.getDeclaredAnnotations()：获取除了继承得到的所有注解</li>
</ul>
<p>构造方法上的注解：使用Constructor获取</p>
<ul>
<li>Constructor.getAnnotation()获取指定类型的注解</li>
<li>Constructor.getAnnotations()获取所有的注解</li>
<li>Constructor.getDeclaredAnnotations() 获取除了继承得到的所有注解</li>
</ul>
<p>属性上的注解：使用Field获取</p>
<ul>
<li>Field.getAnnotation()：获取字段上指定类型的注解</li>
<li>Field.getAnnotations()：获取所有的注解</li>
<li>Field.getDeclaredAnnotations()：获取字段所有的注解</li>
</ul>
<p>定义注解<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME) </div><div class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyAnn &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> "hello"</span>;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">value1</span><span class="params">()</span> <span class="keyword">default</span> 100</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>使用注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MyAnn</span>(value=<span class="string">"hello world"</span>, value1=<span class="number">200</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> a;</div><div class="line">    </div><div class="line">    <span class="meta">@MyAnn</span>(<span class="string">"myMethod"</span>) </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fun</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过反射读取注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Class clazz = MyClass.class;</div><div class="line">        MyAnn myAnn = (MyAnn) clazz.getAnnotation(MyAnn.class); </div><div class="line">        System.out.println(myAnn.value()); </div><div class="line">        System.out.println(myAnn.value1()); </div><div class="line">        </div><div class="line">        Method method = clazz.getMethod(<span class="string">"fun"</span>);</div><div class="line">        MyAnn myAnn1 = method.getAnnotation(MyAnn.class); </div><div class="line">        System.out.println(myAnn1.value());</div><div class="line">        System.out.println(myAnn1.value1());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-3-实现注解小框架"><a href="#4-3-实现注解小框架" class="headerlink" title="4.3 实现注解小框架"></a>4.3 实现注解小框架</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewUtils</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Activity activity)</span> <span class="keyword">throws</span> IllegalAccessException </span>&#123;</div><div class="line">        bindView(activity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bindView</span><span class="params">(Activity activity)</span> <span class="keyword">throws</span> IllegalAccessException </span>&#123;</div><div class="line">        Field[] fields = activity.getClass().getDeclaredFields();</div><div class="line">        <span class="keyword">for</span> (Field field : fields)&#123;</div><div class="line">            ViewInject viewInject = field.getAnnotation(ViewInject.class);</div><div class="line">            <span class="keyword">if</span> (viewInject != <span class="keyword">null</span>)&#123;</div><div class="line">                <span class="keyword">int</span> resId = viewInject.value();</div><div class="line">                View view = activity.findViewById(resId);</div><div class="line">                field.setAccessible(<span class="keyword">true</span>);</div><div class="line">                field.set(activity,view);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(<span class="keyword">final</span> Activity activity)</span></span>&#123;</div><div class="line">        Method[] methods = activity.getClass().getDeclaredMethods();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Method method : methods)&#123;</div><div class="line">            Onclick onclick = method.getAnnotation(Onclick.class);</div><div class="line">            <span class="keyword">if</span> (onclick != <span class="keyword">null</span>)&#123;</div><div class="line">                <span class="keyword">int</span> resId = onclick.value();</div><div class="line">                <span class="keyword">final</span> View view = activity.findViewById(resId);</div><div class="line">                view.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                        method.setAccessible(<span class="keyword">true</span>);</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            method.invoke(activity,view);</div><div class="line">                        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">                            e.printStackTrace();</div><div class="line">                        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">                            e.printStackTrace();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="5-Annotation-Processing-Tool"><a href="#5-Annotation-Processing-Tool" class="headerlink" title="5. Annotation Processing Tool"></a>5. Annotation Processing Tool</h1><p>编译时注解在项目编译的时候生成新的Java文件，这样可以减少手动的代码输入，而且可以不用使用反射，对程序不会造成性能影响。</p>
<h3 id="AbstractProcessor"><a href="#AbstractProcessor" class="headerlink" title="AbstractProcessor"></a>AbstractProcessor</h3><p>注解处理器，javac 自带的一个工具，用来在编译时期扫描处理注解信息</p>
<ul>
<li>process()</li>
<li>init()</li>
<li>Filer</li>
<li>Elements</li>
<li>Messager</li>
</ul>
<p><a href="http://blog.csdn.net/lmj623565791/article/details/51931859" target="_blank" rel="external">Android 如何编写基于编译时注解的项目</a></p>
<p><a href="http://blog.csdn.net/lmj623565791/article/details/43452969" target="_blank" rel="external">Android 打造编译时注解解析框架 这只是一个开始</a></p>
<p><a href="http://yeungeek.com/2016/04/27/Android%E5%85%AC%E5%85%B1%E6%8A%80%E6%9C%AF%E7%82%B9%E4%B9%8B%E4%BA%8C-Annotation-Processing-Tool/?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="external">Android公共技术点之二-Annotation Processing Tool</a></p>
<p><a href="http://www.open-open.com/lib/view/open1470735314518.html" target="_blank" rel="external">Annotation-Processing-Tool详解</a></p>
<p><a href="https://github.com/google/auto" target="_blank" rel="external">Java 生成器源代码集合</a></p>
<h1 id="6-javapoet"><a href="#6-javapoet" class="headerlink" title="6. javapoet"></a>6. javapoet</h1><p>动态生成Java代码，ButterKnife使用了该框架，实现了编译时注解</p>
<p><a href="http://www.jianshu.com/p/95f12f72f69a" target="_blank" rel="external">javapoet——让你从重复无聊的代码中解放出来</a></p>
<h1 id="7-注解框架"><a href="#7-注解框架" class="headerlink" title="7. 注解框架"></a>7. 注解框架</h1><ul>
<li><p>Dagger1</p>
</li>
<li><p>Dagger2</p>
</li>
<li><p>Guice</p>
</li>
<li><p>Butterknife</p>
</li>
<li><p>androidannotations</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/ai.jpg"
               alt="JackChan" />
          <p class="site-author-name" itemprop="name">JackChan</p>
           
              <p class="site-description motion-element" itemprop="description">生活不止眼前的苟且，还有诗和远方！</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/JackChan1999" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.gitbook.com/@alleniverson" target="_blank" title="GitBook">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  GitBook
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/1848214604?topnav=1&wvr=6&topsug=1&is_all=1" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.csdn.net/axi295309066" target="_blank" title="CSDN">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JackChan</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://评论.disqus.com/count.js" async></script>
    

    

  




	





  





  








  





  

  

  

  

  

</body>
</html>
